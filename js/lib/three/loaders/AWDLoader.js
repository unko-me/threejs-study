THREE.AWDLoader=function(){function t(t){this._baseDir=t.substr(0,t.lastIndexOf("/")+1),this._loadingManager=new THREE.LoadingManager}function r(){this.id=0,this.data=null}function e(t){THREE.Loader.call(this,t),this.trunk=new THREE.Object3D,this.materialFactory=void 0,this._resourceLoader=null,this._url=null,this._data,this._ptr=0,this._version=[],this._streaming=!1,this._optimized_for_accuracy=!1,this._compression=0,this._bodylen=4294967295,this._blocks=[new r],this._accuracyMatrix=!1,this._accuracyGeo=!1,this._accuracyProps=!1}var s=1,a=2,i=3,h=4,o=5,n=6,p=7,d=8,u=21,c=23,l=41,_=42,f=43,U=44,y=45,b=46,g=47,T=21,v=23,F=4,m=5,k=7,A=8,E=!0;return t.prototype={loadTexture:function(t){var r=new THREE.Texture,e=new THREE.ImageLoader(this._loadingManager);return e.load(this._baseDir+t,function(t){r.image=t,r.needsUpdate=!0}),r}},e.prototype=new THREE.Loader,e.prototype.constructor=e,e.prototype.load=function(t,r){var e=this;this._url=t;var s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4==s.readyState&&(200==s.status||0==s.status?(e.parse(s.response),r(e.trunk)):console.error("AWDLoader: Couldn't load "+t+" ("+s.status+")"))},s.send(null)},e.prototype.parse=function(t){var r=t.byteLength;for(this._ptr=0,this._data=new DataView(t),this._parseHeader(),0!=this._compression&&console.error("compressed AWD not supported"),this._streaming||this._bodylen==t.byteLength-this._ptr||console.error("AWDLoader: body len does not match file length",this._bodylen,r-this._ptr);this._ptr<r;)this.parseNextBlock()},e.prototype.parseNextBlock=function(){var t,e,s,a,i=this.readU32(),e=(this.readU8(),this.readU8()),s=(this.readU8(),this.readU32());switch(e){case 1:t=this.parseMeshData(s);break;case 22:t=this.parseContainer(s);break;case 23:t=this.parseMeshInstance(s);break;case 81:t=this.parseMaterial(s);break;case 82:t=this.parseTexture(s);break;case 101:t=this.parseSkeleton(s);break;case 112:t=this.parseMeshPoseAnimation(s,!1);break;case 113:t=this.parseVertexAnimationSet(s);break;case 102:t=this.parseSkeletonPose(s);break;case 103:t=this.parseSkeletonAnimation(s);break;case 122:t=this.parseAnimatorSet(s);break;default:this._ptr+=s}this._blocks[i]=a=new r,a.data=t,a.id=i},e.prototype._parseHeader=function(){var t=this._version,r=this.readU8()<<16|this.readU8()<<8|this.readU8();if(4282180!=r)throw new Error("AWDLoader - bad magic");t[0]=this.readU8(),t[1]=this.readU8();var e=this.readU16();this._streaming=1==(1&e),2===t[0]&&1===t[1]&&(this._accuracyMatrix=2===(2&e),this._accuracyGeo=4===(4&e),this._accuracyProps=8===(8&e)),this._geoNrType=this._accuracyGeo?A:k,this._matrixNrType=this._accuracyMatrix?A:k,this._propsNrType=this._accuracyProps?A:k,this._optimized_for_accuracy=2===(2&e),this._compression=this.readU8(),this._bodylen=this.readU32()},e.prototype.parseContainer=function(){var t,r=new THREE.Object3D,e=this.readU32(),s=this.parseMatrix4();return r.name=this.readUTF(),r.applyMatrix(s),t=this._blocks[e].data||this.trunk,t.add(r),this.parseProperties({1:this._matrixNrType,2:this._matrixNrType,3:this._matrixNrType,4:F}),r.extra=this.parseUserAttributes(),r},e.prototype.parseMeshInstance=function(){var t,r,e,s,a,i,h,o,n,p,d,u,c,l,_;for(i=this.readU32(),o=this.parseMatrix4(),t=this.readUTF(),h=this.readU32(),u=this.readU16(),e=this.getBlock(h),n=[],c=0,_=0;u>_;_++)d=this.readU32(),p=this.getBlock(d),n.push(p);if(s=e.length,a=[],s>1)for(r=new THREE.Object3D,_=0;s>_;_++){var f=new THREE.Mesh(e[_]);a.push(f),r.add(f)}else r=new THREE.Mesh(e[0]),a.push(r);r.applyMatrix(o),r.name=t,l=this.getBlock(i)||this.trunk,l.add(r);var U=n.length,y=Math.max(s,U);for(_=0;y>_;_++)a[_%s].material=n[_%U];return this.parseProperties(null),r.extra=this.parseUserAttributes(),r},e.prototype.parseMaterial=function(){var t,r,e,s,a,h,o;for(t=this.readUTF(),r=this.readU8(),h=this.readU8(),e=this.parseProperties({1:i,2:c,11:u,12:p,13:u}),o=0;h>o;){{this.readU16()}this.parseProperties(null),this.parseUserAttributes()}if(a=this.parseUserAttributes(),void 0!==this.materialFactory&&(s=this.materialFactory(t)))return s;if(s=new THREE.MeshPhongMaterial,1===r)s.color.setHex(e.get(1,13421772));else if(2===r){var n=e.get(2,0);s.map=this.getBlock(n)}return s.extra=a,s.alphaThreshold=e.get(12,0),s.repeat=e.get(13,!1),s},e.prototype.parseTexture=function(){var t,r,e=(this.readUTF(),this.readU8());if(0===e){r=this.readU32();var s=this.readUTFBytes(r);console.log(s),t=this.loadTexture(s)}return this.parseProperties(null),this.parseUserAttributes(),t},e.prototype.loadTexture=function(r){return null===this._resourceLoader&&(this._resourceLoader=new t(this._url)),this._resourceLoader.loadTexture(r)},e.prototype.parseSkeleton=function(){var t=(this.readUTF(),this.readU16()),r=[],e=0;for(this.parseProperties(null);t>e;){var s,a;this.readU16(),s=new THREE.Bone,s.parent=this.readU16()-1,s.name=this.readUTF(),a=this.parseMatrix4(),s.skinMatrix=a,this.parseProperties(null),this.parseUserAttributes(),r.push(s),e++}return this.parseUserAttributes(),r},e.prototype.parseSkeletonPose=function(){var t=(this.readUTF(),this.readU16());this.parseProperties(null);for(var r=[],e=0;t>e;){var s,a;s=this.readU8(),a=1===s?this.parseMatrix4():new THREE.Matrix4,r[e]=a,e++}return this.parseUserAttributes(),r},e.prototype.parseSkeletonAnimation=function(){var t,r,e,s=(this.readUTF(),[]),a=this.readU16();this.parseProperties(null);for(var i=0;a>i;)r=this.readU32(),t=this.readU16(),e=this._blocks[r].data,s.push({pose:e,duration:t}),i++;return 0!=s.length?(this.parseUserAttributes(),s):void 0},e.prototype.parseVertexAnimationSet=function(){for(var t,r=(this.readUTF(),this.readU16()),e=(this.parseProperties({1:m}),0),s=[];r>e;)t=this.readU32(),s.push(this._blocks[t].data),e++;return this.parseUserAttributes(),s},e.prototype.parseAnimatorSet=function(){var t,r,e=(this.readUTF(),this.readU16()),s=this.parseProperties({1:v});t=this.readU32();for(var a=this.readU16(),i=[],h=0;a>h;h++)i.push(this.readU32());this.readU16(),Boolean(this.readU8());this.parseUserAttributes(),this.parseUserAttributes();var o=[];for(h=0;h<i.length;h++)o.push(this._blocks[i[h]].data);r=this._blocks[t].data;var n;for(1==e&&(n={animationSet:r,skeleton:this._blocks[s.get(1,0)].data}),h=0;h<o.length;h++)o[h].animator=n;return n},e.prototype.parseMeshData=function(){var t,r,e,s=this.readUTF(),a=this.readU16(),i=0,h=[];for(r=this.parseProperties({1:this._geoNrType,2:this._geoNrType});a>i;){var o,n,p;for(t=new THREE.BufferGeometry,t.name=s,h.push(t),o=this.readU32(),n=this._ptr+o,this.parseProperties({1:this._geoNrType,2:this._geoNrType});this._ptr<n;){var d=0,u=this.readU8(),c=(this.readU8(),this.readU32()),l=c+this._ptr;if(1===u)for(e=new Float32Array(c/12*3),p=new THREE.BufferAttribute(e,3),t.addAttribute("position",p),d=0;this._ptr<l;)e[d]=-this.readF32(),e[d+1]=this.readF32(),e[d+2]=this.readF32(),d+=3;else if(2===u)for(e=new Uint16Array(c/2),p=new THREE.BufferAttribute(e,1),t.addAttribute("index",p),t.offsets.push({start:0,index:0,count:c/2}),d=0;this._ptr<l;)e[d+1]=this.readU16(),e[d]=this.readU16(),e[d+2]=this.readU16(),d+=3;else if(3===u)for(e=new Float32Array(c/8*2),p=new THREE.BufferAttribute(e,2),t.addAttribute("uv",p),d=0;this._ptr<l;)e[d]=this.readF32(),e[d+1]=1-this.readF32(),d+=2;else if(4===u)for(e=new Float32Array(c/12*3),p=new THREE.BufferAttribute(e,3),t.addAttribute("normal",p),d=0;this._ptr<l;)e[d]=-this.readF32(),e[d+1]=this.readF32(),e[d+2]=this.readF32(),d+=3;else this._ptr=l}this.parseUserAttributes(),t.computeBoundingSphere(),i++}return this.parseUserAttributes(),h},e.prototype.parseMeshPoseAnimation=function(t,r){var e,s,a,i,h,o,n,p,d,u,c=1,l=0,_={},f=[],U=(this.readUTF(),this.readU32()),y=this.getBlock(U);if(null==y)return void console.log("parseMeshPoseAnimation target mesh not found at:",U);for(n=y.geometry,n.morphTargets=[],r||(c=this.readU16()),e=this.readU16(),p=this.readU16(),d=0;p>d;)f.push(this.readU16()),d++;for(u=this.parseProperties({1:T,2:T}),_.looping=u.get(1,!0),_.stitchFinalFrame=u.get(2,!1),s=0;c>s;){for(i=this.readU16(),a=0;e>a;)for(d=0,h=this.readU32(),o=this._ptr+h;p>d;){if(1==f[d]){var b=new Float32Array(h/4);for(n.morphTargets.push({array:b}),l=0;this._ptr<o;)b[l]=this.readF32(),b[l+1]=this.readF32(),b[l+2]=this.readF32(),l+=3;a++}else this._ptr=o;d++}s++}return this.parseUserAttributes(),null},e.prototype.getBlock=function(t){return this._blocks[t].data},e.prototype.parseMatrix4=function(){var t=new THREE.Matrix4,r=t.elements;return r[0]=this.readF32(),r[1]=this.readF32(),r[2]=this.readF32(),r[3]=0,r[4]=this.readF32(),r[5]=this.readF32(),r[6]=this.readF32(),r[7]=0,r[8]=this.readF32(),r[9]=this.readF32(),r[10]=this.readF32(),r[11]=0,r[12]=-this.readF32(),r[13]=this.readF32(),r[14]=this.readF32(),r[15]=1,t},e.prototype.parseProperties=function(t){var r=this.readU32(),e=this._ptr+r,s=new AWDProperties;if(t)for(;this._ptr<e;){var a,i=this.readU16(),h=this.readU32();t.hasOwnProperty(i)?(a=t[i],s.set(i,this.parseAttrValue(a,h))):this._ptr+=h}return s},e.prototype.parseUserAttributes=function(){return this._ptr=this.readU32()+this._ptr,null},e.prototype.parseAttrValue=function(t,r){var e,T;switch(t){case s:e=1,T=this.readI8;break;case a:e=2,T=this.readI16;break;case i:e=4,T=this.readI32;break;case u:case h:e=1,T=this.readU8;break;case o:e=2,T=this.readU16;break;case n:case c:e=4,T=this.readU32;break;case p:e=4,T=this.readF32;break;case d:e=8,T=this.readF64;break;case l:case _:case f:case U:case y:case b:case g:e=8,T=this.readF64}if(r>e){var v,F,m;for(v=[],F=0,m=r/e;m>F;)v.push(T.call(this)),F++;return v}return T.call(this)},e.prototype.readU8=function(){return this._data.getUint8(this._ptr++)},e.prototype.readI8=function(){return this._data.getInt8(this._ptr++)},e.prototype.readU16=function(){var t=this._data.getUint16(this._ptr,E);return this._ptr+=2,t},e.prototype.readI16=function(){var t=this._data.getInt16(this._ptr,E);return this._ptr+=2,t},e.prototype.readU32=function(){var t=this._data.getUint32(this._ptr,E);return this._ptr+=4,t},e.prototype.readI32=function(){var t=this._data.getInt32(this._ptr,E);return this._ptr+=4,t},e.prototype.readF32=function(){var t=this._data.getFloat32(this._ptr,E);return this._ptr+=4,t},e.prototype.readF64=function(){var t=this._data.getFloat64(this._ptr,E);return this._ptr+=8,t},e.prototype.readUTF=function(){var t=this.readU16();return this.readUTFBytes(t)},e.prototype.readUTFBytes=function(t){for(var r=[],e=0;r.length<t;){var s=this._data.getUint8(this._ptr++,E);if(128>s)r[e++]=String.fromCharCode(s);else if(s>191&&224>s){var a=this._data.getUint8(this._ptr++,E);r[e++]=String.fromCharCode((31&s)<<6|63&a)}else{var a=this._data.getUint8(this._ptr++,E),i=this._data.getUint8(this._ptr++,E);r[e++]=String.fromCharCode((15&s)<<12|(63&a)<<6|63&i)}}return r.join("")},AWDProperties=function(){},AWDProperties.prototype={set:function(t,r){this[t]=r},get:function(t,r){return this.hasOwnProperty(t)?this[t]:r}},e}();