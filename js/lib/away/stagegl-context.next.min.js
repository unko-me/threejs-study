function mountain_js_context_available(id,driverInfo){var ctx=away.stagegl.ContextStage3D.contexts[id];if(ctx._iCallback){ctx._iDriverInfo=driverInfo;var timeOutId=window.setTimeout(function(){window.clearTimeout(timeOutId);try{ctx._iCallback(ctx)}catch(e){console.log("Callback failed during flash initialization with '"+e.toString()+"'")}},1)}}var aglsl;!function(aglsl){var Sampler=function(){function Sampler(){this.lodbias=0,this.dim=0,this.readmode=0,this.special=0,this.wrap=0,this.mipmap=0,this.filter=0}return Sampler}();aglsl.Sampler=Sampler}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var Token=function(){function Token(){this.dest=new aglsl.Destination,this.opcode=0,this.a=new aglsl.Destination,this.b=new aglsl.Destination}return Token}();aglsl.Token=Token}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var Header=function(){function Header(){this.progid=0,this.version=0,this.type=""}return Header}();aglsl.Header=Header}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var OpLUT=function(){function OpLUT(s,flags,dest,a,b,matrixwidth,matrixheight,ndwm,scaler,dm,lod){this.s=s,this.flags=flags,this.dest=dest,this.a=a,this.b=b,this.matrixwidth=matrixwidth,this.matrixheight=matrixheight,this.ndwm=ndwm,this.scalar=scaler,this.dm=dm,this.lod=lod}return OpLUT}();aglsl.OpLUT=OpLUT}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var Description=function(){function Description(){this.regread=[[],[],[],[],[],[],[]],this.regwrite=[[],[],[],[],[],[],[]],this.hasindirect=!1,this.writedepth=!1,this.hasmatrix=!1,this.samplers=[],this.tokens=[],this.header=new aglsl.Header}return Description}();aglsl.Description=Description}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var Destination=function(){function Destination(){this.mask=0,this.regnum=0,this.regtype=0,this.dim=0}return Destination}();aglsl.Destination=Destination}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var Mapping=function(){function Mapping(){}return Mapping.agal2glsllut=[new aglsl.OpLUT("%dest = %cast(%a);\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(%a + %b);\n",0,!0,!0,!0,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(%a - %b);\n",0,!0,!0,!0,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(%a * %b);\n",0,!0,!0,!0,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(%a / %b);\n",0,!0,!0,!0,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(1.0) / %a;\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(min(%a,%b));\n",0,!0,!0,!0,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(max(%a,%b));\n",0,!0,!0,!0,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(fract(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(sqrt(abs(%a)));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(inversesqrt(abs(%a)));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(pow(abs(%a),%b));\n",0,!0,!0,!0,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(log2(abs(%a)));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(exp2(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(normalize(vec3( %a ) ));\n",0,!0,!0,!1,null,null,!0,null,null,null),new aglsl.OpLUT("%dest = %cast(sin(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(cos(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(cross(vec3(%a),vec3(%b)));\n",0,!0,!0,!0,null,null,!0,null,null,null),new aglsl.OpLUT("%dest = %cast(dot(vec3(%a),vec3(%b)));\n",0,!0,!0,!0,null,null,!0,null,null,null),new aglsl.OpLUT("%dest = %cast(dot(vec4(%a),vec4(%b)));\n",0,!0,!0,!0,null,null,!0,null,null,null),new aglsl.OpLUT("%dest = %cast(abs(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(%a * -1.0);\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(clamp(%a,0.0,1.0));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(dot(vec3(%a),vec3(%b)));\n",null,!0,!0,!0,3,3,!0,null,null,null),new aglsl.OpLUT("%dest = %cast(dot(vec4(%a),vec4(%b)));\n",null,!0,!0,!0,4,4,!0,null,null,null),new aglsl.OpLUT("%dest = %cast(dot(vec4(%a),vec4(%b)));\n",null,!0,!0,!0,4,3,!0,null,null,null),new aglsl.OpLUT("%dest = %cast(dFdx(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(dFdx(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("if (float(%a)==float(%b)) {;\n",0,!1,!0,!0,null,null,null,!0,null,null),new aglsl.OpLUT("if (float(%a)!=float(%b)) {;\n",0,!1,!0,!0,null,null,null,!0,null,null),new aglsl.OpLUT("if (float(%a)>=float(%b)) {;\n",0,!1,!0,!0,null,null,null,!0,null,null),new aglsl.OpLUT("if (float(%a)<float(%b)) {;\n",0,!1,!0,!0,null,null,null,!0,null,null),new aglsl.OpLUT("} else {;\n",0,!1,!1,!1,null,null,null,null,null,null),new aglsl.OpLUT("};\n",0,!1,!1,!1,null,null,null,null,null,null),new aglsl.OpLUT(null,null,null,null,!1,null,null,null,null,null,null),new aglsl.OpLUT(null,null,null,null,!1,null,null,null,null,null,null),new aglsl.OpLUT(null,null,null,null,!1,null,null,null,null,null,null),new aglsl.OpLUT(null,null,null,null,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(texture%texdimLod(%b,%texsize(%a)).%dm);\n",null,!0,!0,!0,null,null,null,null,!0,null),new aglsl.OpLUT("if ( float(%a)<0.0 ) discard;\n",null,!1,!0,!1,null,null,null,!0,null,null),new aglsl.OpLUT("%dest = %cast(texture%texdim(%b,%texsize(%a)%lod).%dm);\n",null,!0,!0,!0,null,null,!0,null,!0,!0),new aglsl.OpLUT("%dest = %cast(greaterThanEqual(%a,%b).%dm);\n",0,!0,!0,!0,null,null,!0,null,!0,null),new aglsl.OpLUT("%dest = %cast(lessThan(%a,%b).%dm);\n",0,!0,!0,!0,null,null,!0,null,!0,null),new aglsl.OpLUT("%dest = %cast(sign(%a));\n",0,!0,!0,!1,null,null,null,null,null,null),new aglsl.OpLUT("%dest = %cast(equal(%a,%b).%dm);\n",0,!0,!0,!0,null,null,!0,null,!0,null),new aglsl.OpLUT("%dest = %cast(notEqual(%a,%b).%dm);\n",0,!0,!0,!0,null,null,!0,null,!0,null)],Mapping}();aglsl.Mapping=Mapping}(aglsl||(aglsl={}));var aglsl;!function(aglsl){!function(assembler){var Opcode=function(){function Opcode(dest,aformat,asize,bformat,bsize,opcode,simple,horizontal,fragonly,matrix){this.a=new aglsl.assembler.FS,this.b=new aglsl.assembler.FS,this.flags=new aglsl.assembler.Flags,this.dest=dest,this.a.format=aformat,this.a.size=asize,this.b.format=bformat,this.b.size=bsize,this.opcode=opcode,this.flags.simple=simple,this.flags.horizontal=horizontal,this.flags.fragonly=fragonly,this.flags.matrix=matrix}return Opcode}();assembler.Opcode=Opcode;var FS=function(){function FS(){}return FS}();assembler.FS=FS;var Flags=function(){function Flags(){}return Flags}();assembler.Flags=Flags}(aglsl.assembler||(aglsl.assembler={}));aglsl.assembler}(aglsl||(aglsl={}));var aglsl;!function(aglsl){!function(assembler){var OpcodeMap=function(){function OpcodeMap(){}return Object.defineProperty(OpcodeMap,"map",{get:function(){return OpcodeMap._map||(OpcodeMap._map=new Array,OpcodeMap._map.mov=new aglsl.assembler.Opcode("vector","vector",4,"none",0,0,!0,null,null,null),OpcodeMap._map.add=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,1,!0,null,null,null),OpcodeMap._map.sub=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,2,!0,null,null,null),OpcodeMap._map.mul=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,3,!0,null,null,null),OpcodeMap._map.div=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,4,!0,null,null,null),OpcodeMap._map.rcp=new aglsl.assembler.Opcode("vector","vector",4,"none",0,5,!0,null,null,null),OpcodeMap._map.min=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,6,!0,null,null,null),OpcodeMap._map.max=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,7,!0,null,null,null),OpcodeMap._map.frc=new aglsl.assembler.Opcode("vector","vector",4,"none",0,8,!0,null,null,null),OpcodeMap._map.sqt=new aglsl.assembler.Opcode("vector","vector",4,"none",0,9,!0,null,null,null),OpcodeMap._map.rsq=new aglsl.assembler.Opcode("vector","vector",4,"none",0,10,!0,null,null,null),OpcodeMap._map.pow=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,11,!0,null,null,null),OpcodeMap._map.log=new aglsl.assembler.Opcode("vector","vector",4,"none",0,12,!0,null,null,null),OpcodeMap._map.exp=new aglsl.assembler.Opcode("vector","vector",4,"none",0,13,!0,null,null,null),OpcodeMap._map.nrm=new aglsl.assembler.Opcode("vector","vector",4,"none",0,14,!0,null,null,null),OpcodeMap._map.sin=new aglsl.assembler.Opcode("vector","vector",4,"none",0,15,!0,null,null,null),OpcodeMap._map.cos=new aglsl.assembler.Opcode("vector","vector",4,"none",0,16,!0,null,null,null),OpcodeMap._map.crs=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,17,!0,!0,null,null),OpcodeMap._map.dp3=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,18,!0,!0,null,null),OpcodeMap._map.dp4=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,19,!0,!0,null,null),OpcodeMap._map.abs=new aglsl.assembler.Opcode("vector","vector",4,"none",0,20,!0,null,null,null),OpcodeMap._map.neg=new aglsl.assembler.Opcode("vector","vector",4,"none",0,21,!0,null,null,null),OpcodeMap._map.sat=new aglsl.assembler.Opcode("vector","vector",4,"none",0,22,!0,null,null,null),OpcodeMap._map.ted=new aglsl.assembler.Opcode("vector","vector",4,"sampler",1,38,!0,null,!0,null),OpcodeMap._map.kil=new aglsl.assembler.Opcode("none","scalar",1,"none",0,39,!0,null,!0,null),OpcodeMap._map.tex=new aglsl.assembler.Opcode("vector","vector",4,"sampler",1,40,!0,null,!0,null),OpcodeMap._map.m33=new aglsl.assembler.Opcode("vector","matrix",3,"vector",3,23,!0,null,null,!0),OpcodeMap._map.m44=new aglsl.assembler.Opcode("vector","matrix",4,"vector",4,24,!0,null,null,!0),OpcodeMap._map.m43=new aglsl.assembler.Opcode("vector","matrix",3,"vector",4,25,!0,null,null,!0),OpcodeMap._map.sge=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,41,!0,null,null,null),OpcodeMap._map.slt=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,42,!0,null,null,null),OpcodeMap._map.sgn=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,43,!0,null,null,null),OpcodeMap._map.seq=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,44,!0,null,null,null),OpcodeMap._map.sne=new aglsl.assembler.Opcode("vector","vector",4,"vector",4,45,!0,null,null,null)),OpcodeMap._map},enumerable:!0,configurable:!0}),OpcodeMap}();assembler.OpcodeMap=OpcodeMap}(aglsl.assembler||(aglsl.assembler={}));aglsl.assembler}(aglsl||(aglsl={}));var aglsl;!function(aglsl){!function(assembler){var Part=function(){function Part(name,version){"undefined"==typeof name&&(name=null),"undefined"==typeof version&&(version=null),this.name="",this.version=0,this.name=name,this.version=version,this.data=new away.utils.ByteArray}return Part}();assembler.Part=Part}(aglsl.assembler||(aglsl.assembler={}));aglsl.assembler}(aglsl||(aglsl={}));var aglsl;!function(aglsl){!function(assembler){var Reg=function(){function Reg(code,desc){this.code=code,this.desc=desc}return Reg}();assembler.Reg=Reg;var RegMap=function(){function RegMap(){}return Object.defineProperty(RegMap,"map",{get:function(){return RegMap._map||(RegMap._map=new Array,RegMap._map.va=new aglsl.assembler.Reg(0,"vertex attribute"),RegMap._map.fc=new aglsl.assembler.Reg(1,"fragment constant"),RegMap._map.vc=new aglsl.assembler.Reg(1,"vertex constant"),RegMap._map.ft=new aglsl.assembler.Reg(2,"fragment temporary"),RegMap._map.vt=new aglsl.assembler.Reg(2,"vertex temporary"),RegMap._map.vo=new aglsl.assembler.Reg(3,"vertex output"),RegMap._map.op=new aglsl.assembler.Reg(3,"vertex output"),RegMap._map.fd=new aglsl.assembler.Reg(3,"fragment depth output"),RegMap._map.fo=new aglsl.assembler.Reg(3,"fragment output"),RegMap._map.oc=new aglsl.assembler.Reg(3,"fragment output"),RegMap._map.v=new aglsl.assembler.Reg(4,"varying"),RegMap._map.vi=new aglsl.assembler.Reg(4,"varying output"),RegMap._map.fi=new aglsl.assembler.Reg(4,"varying input"),RegMap._map.fs=new aglsl.assembler.Reg(5,"sampler")),RegMap._map},enumerable:!0,configurable:!0}),RegMap}();assembler.RegMap=RegMap}(aglsl.assembler||(aglsl.assembler={}));aglsl.assembler}(aglsl||(aglsl={}));var aglsl;!function(aglsl){!function(assembler){var Sampler=function(){function Sampler(shift,mask,value){this.shift=shift,this.mask=mask,this.value=value}return Sampler}();assembler.Sampler=Sampler;var SamplerMap=function(){function SamplerMap(){}return Object.defineProperty(SamplerMap,"map",{get:function(){return SamplerMap._map||(SamplerMap._map=new Array,SamplerMap._map.rgba=new aglsl.assembler.Sampler(8,15,0),SamplerMap._map.rg=new aglsl.assembler.Sampler(8,15,5),SamplerMap._map.r=new aglsl.assembler.Sampler(8,15,4),SamplerMap._map.compressed=new aglsl.assembler.Sampler(8,15,1),SamplerMap._map.compressed_alpha=new aglsl.assembler.Sampler(8,15,2),SamplerMap._map.dxt1=new aglsl.assembler.Sampler(8,15,1),SamplerMap._map.dxt5=new aglsl.assembler.Sampler(8,15,2),SamplerMap._map["2d"]=new aglsl.assembler.Sampler(12,15,0),SamplerMap._map.cube=new aglsl.assembler.Sampler(12,15,1),SamplerMap._map["3d"]=new aglsl.assembler.Sampler(12,15,2),SamplerMap._map.centroid=new aglsl.assembler.Sampler(16,1,1),SamplerMap._map.ignoresampler=new aglsl.assembler.Sampler(16,4,4),SamplerMap._map.clamp=new aglsl.assembler.Sampler(20,15,0),SamplerMap._map.repeat=new aglsl.assembler.Sampler(20,15,1),SamplerMap._map.wrap=new aglsl.assembler.Sampler(20,15,1),SamplerMap._map.nomip=new aglsl.assembler.Sampler(24,15,0),SamplerMap._map.mipnone=new aglsl.assembler.Sampler(24,15,0),SamplerMap._map.mipnearest=new aglsl.assembler.Sampler(24,15,1),SamplerMap._map.miplinear=new aglsl.assembler.Sampler(24,15,2),SamplerMap._map.nearest=new aglsl.assembler.Sampler(28,15,0),SamplerMap._map.linear=new aglsl.assembler.Sampler(28,15,1)),SamplerMap._map},enumerable:!0,configurable:!0}),SamplerMap}();assembler.SamplerMap=SamplerMap}(aglsl.assembler||(aglsl.assembler={}));aglsl.assembler}(aglsl||(aglsl={}));var aglsl;!function(aglsl){!function(assembler){var AGALMiniAssembler=function(){function AGALMiniAssembler(){this.r={},this.cur=new aglsl.assembler.Part}return AGALMiniAssembler.prototype.assemble=function(source,ext_part,ext_version){"undefined"==typeof ext_part&&(ext_part=null),"undefined"==typeof ext_version&&(ext_version=null),ext_version||(ext_version=1),ext_part&&this.addHeader(ext_part,ext_version);var lines=source.replace(/[\f\n\r\v]+/g,"\n").split("\n");for(var i in lines)this.processLine(lines[i],i);return this.r},AGALMiniAssembler.prototype.processLine=function(line,linenr){var startcomment=line.search("//");if(-1!=startcomment&&(line=line.slice(0,startcomment)),line=line.replace(/^\s+|\s+$/g,""),line.length>0){var optsi=line.search(/<.*>/g),opts=null;-1!=optsi&&(opts=line.slice(optsi).match(/([\w\.\-\+]+)/gi),line=line.slice(0,optsi));var tokens=line.match(/([\w\.\+\[\]]+)/gi);if(!tokens||tokens.length<1)return line.length>=3&&console.log("Warning: bad line "+linenr+": "+line),void 0;switch(tokens[0]){case"part":this.addHeader(tokens[1],Number(tokens[2]));break;case"endpart":if(!this.cur)throw"Unexpected endpart";return this.cur.data.position=0,this.cur=null,void 0;default:if(!this.cur)return console.log("Warning: bad line "+linenr+": "+line+" (Outside of any part definition)"),void 0;if("comment"==this.cur.name)return;var op=assembler.OpcodeMap.map[tokens[0]];if(!op)throw"Bad opcode "+tokens[0]+" "+linenr+": "+line;this.emitOpcode(this.cur,op.opcode);var ti=1;if(op.dest&&"none"!=op.dest){if(!this.emitDest(this.cur,tokens[ti++],op.dest))throw"Bad destination register "+tokens[ti-1]+" "+linenr+": "+line}else this.emitZeroDword(this.cur);if(op.a&&"none"!=op.a.format){if(!this.emitSource(this.cur,tokens[ti++],op.a))throw"Bad source register "+tokens[ti-1]+" "+linenr+": "+line}else this.emitZeroQword(this.cur);if(op.b&&"none"!=op.b.format){if("sampler"==op.b.format){if(!this.emitSampler(this.cur,tokens[ti++],op.b,opts))throw"Bad sampler register "+tokens[ti-1]+" "+linenr+": "+line}else if(!this.emitSource(this.cur,tokens[ti++],op.b))throw"Bad source register "+tokens[ti-1]+" "+linenr+": "+line}else this.emitZeroQword(this.cur)}}},AGALMiniAssembler.prototype.emitHeader=function(pr){switch(pr.data.writeUnsignedByte(160),pr.data.writeUnsignedInt(pr.version),pr.version>=16&&pr.data.writeUnsignedByte(0),pr.data.writeUnsignedByte(161),pr.name){case"fragment":pr.data.writeUnsignedByte(1);break;case"vertex":pr.data.writeUnsignedByte(0);break;case"cpu":pr.data.writeUnsignedByte(2);break;default:pr.data.writeUnsignedByte(255)}},AGALMiniAssembler.prototype.emitOpcode=function(pr,opcode){pr.data.writeUnsignedInt(opcode)},AGALMiniAssembler.prototype.emitZeroDword=function(pr){pr.data.writeUnsignedInt(0)},AGALMiniAssembler.prototype.emitZeroQword=function(pr){pr.data.writeUnsignedInt(0),pr.data.writeUnsignedInt(0)},AGALMiniAssembler.prototype.emitDest=function(pr,token){var reg=token.match(/([fov]?[tpocidavs])(\d*)(\.[xyzw]{1,4})?/i);if(!assembler.RegMap.map[reg[1]])return!1;var em={num:reg[2]?reg[2]:0,code:assembler.RegMap.map[reg[1]].code,mask:this.stringToMask(reg[3])};return pr.data.writeUnsignedShort(em.num),pr.data.writeUnsignedByte(em.mask),pr.data.writeUnsignedByte(em.code),!0},AGALMiniAssembler.prototype.stringToMask=function(s){if(!s)return 15;var r=0;return-1!=s.indexOf("x")&&(r|=1),-1!=s.indexOf("y")&&(r|=2),-1!=s.indexOf("z")&&(r|=4),-1!=s.indexOf("w")&&(r|=8),r},AGALMiniAssembler.prototype.stringToSwizzle=function(s){if(!s)return 228;var chartoindex={x:0,y:1,z:2,w:3},sw=0;if("."!=s.charAt(0))throw"Missing . for swizzle";return s.length>1&&(sw|=chartoindex[s.charAt(1)]),sw|=s.length>2?chartoindex[s.charAt(2)]<<2:(3&sw)<<2,sw|=s.length>3?chartoindex[s.charAt(3)]<<4:(12&sw)<<2,sw|=s.length>4?chartoindex[s.charAt(4)]<<6:(48&sw)<<2},AGALMiniAssembler.prototype.emitSampler=function(pr,token,opsrc,opts){var reg=token.match(/fs(\d*)/i);if(!reg||!reg[1])return!1;pr.data.writeUnsignedShort(parseInt(reg[1])),pr.data.writeUnsignedByte(0),pr.data.writeUnsignedByte(0);for(var samplerbits=5,sampleroptset=0,i=0;i<opts.length;i++){var o=assembler.SamplerMap.map[opts[i].toLowerCase()];o?(0!=(sampleroptset>>o.shift&o.mask)&&console.log("Warning, duplicate sampler option"),sampleroptset|=o.mask<<o.shift,samplerbits&=~(o.mask<<o.shift),samplerbits|=o.value<<o.shift):console.log("Warning, unknown sampler option: ",opts[i])}return pr.data.writeUnsignedInt(samplerbits),!0},AGALMiniAssembler.prototype.emitSource=function(pr,token){var reg,indexed=token.match(/vc\[(v[tcai])(\d+)\.([xyzw])([\+\-]\d+)?\](\.[xyzw]{1,4})?/i);if(indexed){if(!assembler.RegMap.map[indexed[1]])return!1;var selindex={x:0,y:1,z:2,w:3},em={num:0|indexed[2],code:assembler.RegMap.map[indexed[1]].code,swizzle:this.stringToSwizzle(indexed[5]),select:selindex[indexed[3]],offset:0|indexed[4]};pr.data.writeUnsignedShort(em.num),pr.data.writeByte(em.offset),pr.data.writeUnsignedByte(em.swizzle),pr.data.writeUnsignedByte(1),pr.data.writeUnsignedByte(em.code),pr.data.writeUnsignedByte(em.select),pr.data.writeUnsignedByte(128)}else{if(reg=token.match(/([fov]?[tpocidavs])(\d*)(\.[xyzw]{1,4})?/i),!assembler.RegMap.map[reg[1]])return!1;var em={num:0|reg[2],code:assembler.RegMap.map[reg[1]].code,swizzle:this.stringToSwizzle(reg[3])};pr.data.writeUnsignedShort(em.num),pr.data.writeUnsignedByte(0),pr.data.writeUnsignedByte(em.swizzle),pr.data.writeUnsignedByte(em.code),pr.data.writeUnsignedByte(0),pr.data.writeUnsignedByte(0),pr.data.writeUnsignedByte(0)}return!0},AGALMiniAssembler.prototype.addHeader=function(partname,version){if(version||(version=1),void 0==this.r[partname])this.r[partname]=new aglsl.assembler.Part(partname,version),this.emitHeader(this.r[partname]);else if(this.r[partname].version!=version)throw"Multiple versions for part "+partname;this.cur=this.r[partname]},AGALMiniAssembler}();assembler.AGALMiniAssembler=AGALMiniAssembler}(aglsl.assembler||(aglsl.assembler={}));aglsl.assembler}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var AGALTokenizer=function(){function AGALTokenizer(){}return AGALTokenizer.prototype.decribeAGALByteArray=function(bytes){var header=new aglsl.Header;if(160!=bytes.readUnsignedByte())throw"Bad AGAL: Missing 0xa0 magic byte.";if(header.version=bytes.readUnsignedInt(),header.version>=16&&(bytes.readUnsignedByte(),header.version>>=1),161!=bytes.readUnsignedByte())throw"Bad AGAL: Missing 0xa1 magic byte.";switch(header.progid=bytes.readUnsignedByte(),header.progid){case 1:header.type="fragment";break;case 0:header.type="vertex";break;case 2:header.type="cpu";break;default:header.type=""}for(var desc=new aglsl.Description,tokens=[];bytes.position<bytes.length;){var token=new aglsl.Token;token.opcode=bytes.readUnsignedInt();var lutentry=aglsl.Mapping.agal2glsllut[token.opcode];if(!lutentry)throw"Opcode not valid or not implemented yet: "+token.opcode;lutentry.matrixheight&&(desc.hasmatrix=!0),lutentry.dest?(token.dest.regnum=bytes.readUnsignedShort(),token.dest.mask=bytes.readUnsignedByte(),token.dest.regtype=bytes.readUnsignedByte(),desc.regwrite[token.dest.regtype][token.dest.regnum]|=token.dest.mask):(token.dest=null,bytes.readUnsignedInt()),lutentry.a?this.readReg(token.a,1,desc,bytes):(token.a=null,bytes.readUnsignedInt(),bytes.readUnsignedInt()),lutentry.b?this.readReg(token.b,0|lutentry.matrixheight,desc,bytes):(token.b=null,bytes.readUnsignedInt(),bytes.readUnsignedInt()),tokens.push(token)}return desc.header=header,desc.tokens=tokens,desc},AGALTokenizer.prototype.readReg=function(s,mh,desc,bytes){if(s.regnum=bytes.readUnsignedShort(),s.indexoffset=bytes.readByte(),s.swizzle=bytes.readUnsignedByte(),s.regtype=bytes.readUnsignedByte(),desc.regread[s.regtype][s.regnum]=15,5==s.regtype?(s.lodbiad=s.indexoffset,s.indexoffset=void 0,s.swizzle=void 0,s.readmode=bytes.readUnsignedByte(),s.dim=s.readmode>>4,s.readmode&=15,s.special=bytes.readUnsignedByte(),s.wrap=s.special>>4,s.special&=15,s.mipmap=bytes.readUnsignedByte(),s.filter=s.mipmap>>4,s.mipmap&=15,desc.samplers[s.regnum]=s):(s.indexregtype=bytes.readUnsignedByte(),s.indexselect=bytes.readUnsignedByte(),s.indirectflag=bytes.readUnsignedByte()),s.indirectflag&&(desc.hasindirect=!0),!s.indirectflag&&mh)for(var mhi=0;mh>mhi;mhi++)desc.regread[s.regtype][s.regnum+mhi]=desc.regread[s.regtype][s.regnum]},AGALTokenizer}();aglsl.AGALTokenizer=AGALTokenizer}(aglsl||(aglsl={}));var aglsl;!function(aglsl){var AGLSLParser=function(){function AGLSLParser(){}return AGLSLParser.prototype.parse=function(desc){var header="",body="";header+="precision highp float;\n";var tag=desc.header.type[0];if("vertex"==desc.header.type&&(header+="uniform float yflip;\n"),desc.hasindirect)header+="uniform vec4 "+tag+"carrr["+away.stagegl.ContextStage3D.maxvertexconstants+"];\n";else for(var i=0;i<desc.regread[1].length;i++)desc.regread[1][i]&&(header+="uniform vec4 "+tag+"c"+i+";\n");for(var i=0;i<desc.regread[2].length||i<desc.regwrite[2].length;i++)(desc.regread[2][i]||desc.regwrite[2][i])&&(header+="vec4 "+tag+"t"+i+";\n");for(var i=0;i<desc.regread[0].length;i++)desc.regread[0][i]&&(header+="attribute vec4 va"+i+";\n");for(var i=0;i<desc.regread[4].length||i<desc.regwrite[4].length;i++)(desc.regread[4][i]||desc.regwrite[4][i])&&(header+="varying vec4 vi"+i+";\n");for(var samptype=["2D","Cube","3D",""],i=0;i<desc.samplers.length;i++)desc.samplers[i]&&(header+="uniform sampler"+samptype[3&desc.samplers[i].dim]+" fs"+i+";\n");"vertex"==desc.header.type&&(header+="vec4 outpos;\n"),desc.writedepth&&(header+="vec4 tmp_FragDepth;\n"),body+="void main() {\n";for(var i=0;i<desc.tokens.length;i++){var lutentry=aglsl.Mapping.agal2glsllut[desc.tokens[i].opcode];if(!lutentry)throw"Opcode not valid or not implemented yet: ";for(var sublines=lutentry.matrixheight||1,sl=0;sublines>sl;sl++){var line="  "+lutentry.s;if(desc.tokens[i].dest){if(lutentry.matrixheight){if(1!=(desc.tokens[i].dest.mask>>sl&1))continue;var destregstring=this.regtostring(desc.tokens[i].dest.regtype,desc.tokens[i].dest.regnum,desc,tag),destcaststring="float",destmaskstring=["x","y","z","w"][sl];destregstring+="."+destmaskstring}else{var destcaststring,destmaskstring,destregstring=this.regtostring(desc.tokens[i].dest.regtype,desc.tokens[i].dest.regnum,desc,tag);if(15!=desc.tokens[i].dest.mask){var ndest=0;switch(destmaskstring="",1&desc.tokens[i].dest.mask&&(ndest++,destmaskstring+="x"),2&desc.tokens[i].dest.mask&&(ndest++,destmaskstring+="y"),4&desc.tokens[i].dest.mask&&(ndest++,destmaskstring+="z"),8&desc.tokens[i].dest.mask&&(ndest++,destmaskstring+="w"),destregstring+="."+destmaskstring,ndest){case 1:destcaststring="float";break;case 2:destcaststring="vec2";break;case 3:destcaststring="vec3";break;default:throw"Unexpected destination mask"}}else destcaststring="vec4",destmaskstring="xyzw"}line=line.replace("%dest",destregstring),line=line.replace("%cast",destcaststring),line=line.replace("%dm",destmaskstring)}var dwm=15;if(!lutentry.ndwm&&lutentry.dest&&desc.tokens[i].dest&&(dwm=desc.tokens[i].dest.mask),desc.tokens[i].a&&(line=line.replace("%a",this.sourcetostring(desc.tokens[i].a,0,dwm,lutentry.scalar,desc,tag))),desc.tokens[i].b&&(line=line.replace("%b",this.sourcetostring(desc.tokens[i].b,sl,dwm,lutentry.scalar,desc,tag)),5==desc.tokens[i].b.regtype)){var texdim=["2D","Cube","3D"][desc.tokens[i].b.dim],texsize=["vec2","vec3","vec3"][desc.tokens[i].b.dim];line=line.replace("%texdim",texdim),line=line.replace("%texsize",texsize);var texlod="";line=line.replace("%lod",texlod)}body+=line}}return"vertex"==desc.header.type&&(body+="  gl_Position = vec4(outpos.x, outpos.y, outpos.z*2.0 - outpos.w, outpos.w);\n"),desc.writedepth&&(body+="  gl_FragDepth = clamp(tmp_FragDepth,0.0,1.0);\n"),body+="}\n",header+body},AGLSLParser.prototype.regtostring=function(regtype,regnum,desc,tag){switch(regtype){case 0:return"va"+regnum;case 1:return desc.hasindirect&&"vertex"==desc.header.type?"vcarrr["+regnum+"]":tag+"c"+regnum;case 2:return tag+"t"+regnum;case 3:return"vertex"==desc.header.type?"outpos":"gl_FragColor";case 4:return"vi"+regnum;case 5:return"fs"+regnum;case 6:return"tmp_FragDepth";default:throw"Unknown register type"}},AGLSLParser.prototype.sourcetostring=function(s,subline,dwm,isscalar,desc,tag){var r,swiz=["x","y","z","w"];if(s.indirectflag){r="vcarrr[int("+this.regtostring(s.indexregtype,s.regnum,desc,tag)+"."+swiz[s.indexselect]+")";var realofs=subline+s.indexoffset;0>realofs&&(r+=realofs.toString()),realofs>0&&(r+="+"+realofs.toString()),r+="]"}else r=this.regtostring(s.regtype,s.regnum+subline,desc,tag);return 5==s.regtype?r:isscalar?r+"."+swiz[s.swizzle>>0&3]:228==s.swizzle&&15==dwm?r:(r+=".",1&dwm&&(r+=swiz[s.swizzle>>0&3]),2&dwm&&(r+=swiz[s.swizzle>>2&3]),4&dwm&&(r+=swiz[s.swizzle>>4&3]),8&dwm&&(r+=swiz[s.swizzle>>6&3]),r)},AGLSLParser}();aglsl.AGLSLParser=AGLSLParser}(aglsl||(aglsl={}));var away;!function(away){!function(pool){var IndexData=function(){function IndexData(level){this._dataDirty=!0,this.invalid=new Array(8),this.contexts=new Array(8),this.buffers=new Array(8),this.level=level}return IndexData.prototype.updateData=function(offset,indices,numVertices){if(this._dataDirty)if(this._dataDirty=!1,indices.length<IndexData.LIMIT_INDICES&&numVertices<IndexData.LIMIT_VERTS)this.indexMappings=null,this.originalIndices=null,this.setData(indices),this.offset=indices.length;else{var i,len,outIndex,j,k,splitIndices=new Array;for(this.indexMappings=new Array(indices.length),this.originalIndices=new Array,i=this.indexMappings.length;i--;)this.indexMappings[i]=-1;var originalIndex,splitIndex;for(outIndex=0,len=indices.length,i=offset,k=0;len>i&&outIndex+3<IndexData.LIMIT_INDICES&&k+3<IndexData.LIMIT_VERTS;){for(j=0;3>j;j++)originalIndex=indices[i+j],this.indexMappings[originalIndex]>=0?splitIndex=this.indexMappings[originalIndex]:(splitIndex=k++,this.indexMappings[originalIndex]=splitIndex,this.originalIndices.push(originalIndex)),splitIndices[outIndex+j]=splitIndex;outIndex+=3,i+=3}this.setData(splitIndices),this.offset=i}},IndexData.prototype.invalidateData=function(){this._dataDirty=!0},IndexData.prototype.dispose=function(){for(var i=0;8>i;++i)this.contexts[i]&&(this.contexts[i].disposeIndexData(this),this.contexts[i]=null)},IndexData.prototype.disposeBuffers=function(){for(var i=0;8>i;++i)this.buffers[i]&&(this.buffers[i].dispose(),this.buffers[i]=null)},IndexData.prototype.invalidateBuffers=function(){for(var i=0;8>i;++i)this.invalid[i]=!0},IndexData.prototype.setData=function(data){this.data&&this.data.length!=data.length?this.disposeBuffers():this.invalidateBuffers(),this.data=data},IndexData.LIMIT_VERTS=65535,IndexData.LIMIT_INDICES=16777215,IndexData}();pool.IndexData=IndexData}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(pool){var IndexDataPool=function(){function IndexDataPool(){}return IndexDataPool.getItem=function(subGeometry,level,indexOffset){var subGeometryData=IndexDataPool._pool[subGeometry.id]||(IndexDataPool._pool[subGeometry.id]=new Array),indexData=subGeometryData[level]||(subGeometryData[level]=new pool.IndexData(level));return indexData.updateData(indexOffset,subGeometry.indices,subGeometry.numVertices),indexData},IndexDataPool.disposeItem=function(id,level){var subGeometryData=this._pool[id];subGeometryData[level].dispose(),subGeometryData[level]=null},IndexDataPool.prototype.disposeData=function(id){for(var subGeometryData=IndexDataPool._pool[id],len=subGeometryData.length,i=0;len>i;i++)subGeometryData[i].dispose(),subGeometryData[i]=null;IndexDataPool._pool[id]=null},IndexDataPool._pool=new Object,IndexDataPool}();pool.IndexDataPool=IndexDataPool}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(pool){var TextureData=function(){function TextureData(context,textureProxy){this.context=context,this.textureProxy=textureProxy}return TextureData.prototype.dispose=function(){this.texture.dispose(),this.texture=null},TextureData.prototype.invalidate=function(){this.invalid=!0},TextureData}();pool.TextureData=TextureData}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(pool){var TextureDataPool=function(){function TextureDataPool(context){this._pool=new Object,this._context=context}return TextureDataPool.prototype.getItem=function(textureProxy){return this._pool[textureProxy.id]||(this._pool[textureProxy.id]=textureProxy._iAddTextureData(new pool.TextureData(this._context,textureProxy)))},TextureDataPool.prototype.disposeItem=function(textureProxy){textureProxy._iRemoveTextureData(this._pool[textureProxy.id]),this._pool[textureProxy.id]=null},TextureDataPool}();pool.TextureDataPool=TextureDataPool}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(pool){var SubGeometryBase=away.base.SubGeometryBase,SubGeometryEvent=away.events.SubGeometryEvent,VertexData=function(){function VertexData(subGeometry,dataType){var _this=this;this._dataDirty=!0,this.invalid=new Array(8),this.buffers=new Array(8),this.contexts=new Array(8),this._subGeometry=subGeometry,this._dataType=dataType,this._onVerticesUpdatedDelegate=function(event){return _this._onVerticesUpdated(event)},this._subGeometry.addEventListener(SubGeometryEvent.VERTICES_UPDATED,this._onVerticesUpdatedDelegate)}return VertexData.prototype.updateData=function(originalIndices,indexMappings){if("undefined"==typeof originalIndices&&(originalIndices=null),"undefined"==typeof indexMappings&&(indexMappings=null),this._dataDirty){this._dataDirty=!1,this.dataPerVertex=this._subGeometry.getStride(this._dataType);var vertices=this._subGeometry[this._dataType];if(null==indexMappings)this.setData(vertices);else{for(var originalIndex,splitIndex,splitVerts=new Array(originalIndices.length*this.dataPerVertex),i=0,j=0;i<originalIndices.length;){for(originalIndex=originalIndices[i],splitIndex=indexMappings[originalIndex]*this.dataPerVertex,originalIndex*=this.dataPerVertex,j=0;j<this.dataPerVertex;j++)splitVerts[splitIndex+j]=vertices[originalIndex+j];i++}this.setData(splitVerts)
}}},VertexData.prototype.dispose=function(){for(var i=0;8>i;++i)this.contexts[i]&&(this.contexts[i].disposeVertexData(this),this.contexts[i]=null)},VertexData.prototype.disposeBuffers=function(){for(var i=0;8>i;++i)this.buffers[i]&&(this.buffers[i].dispose(),this.buffers[i]=null)},VertexData.prototype.invalidateBuffers=function(){for(var i=0;8>i;++i)this.invalid[i]=!0},VertexData.prototype.setData=function(data){this.data&&this.data.length!=data.length?this.disposeBuffers():this.invalidateBuffers(),this.data=data},VertexData.prototype._onVerticesUpdated=function(event){var dataType=this._subGeometry.concatenateArrays?SubGeometryBase.VERTEX_DATA:event.dataType;dataType==this._dataType&&(this._dataDirty=!0)},VertexData}();pool.VertexData=VertexData}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(pool){var SubGeometryBase=away.base.SubGeometryBase,VertexDataPool=function(){function VertexDataPool(){}return VertexDataPool.getItem=function(subGeometry,indexData,dataType){subGeometry.concatenateArrays&&(dataType=SubGeometryBase.VERTEX_DATA);var subGeometryDictionary=VertexDataPool._pool[subGeometry.id]||(VertexDataPool._pool[subGeometry.id]=new Object),subGeometryData=subGeometryDictionary[dataType]||(subGeometryDictionary[dataType]=new Array),vertexData=subGeometryData[indexData.level]||(subGeometryData[indexData.level]=new pool.VertexData(subGeometry,dataType));return vertexData.updateData(indexData.originalIndices,indexData.indexMappings),vertexData},VertexDataPool.disposeItem=function(subGeometry,level,dataType){var subGeometryDictionary=VertexDataPool._pool[subGeometry.id],subGeometryData=subGeometryDictionary[dataType];subGeometryData[level].dispose(),subGeometryData[level]=null},VertexDataPool.prototype.disposeData=function(subGeometry){var subGeometryDictionary=VertexDataPool._pool[subGeometry.id];for(var key in subGeometryDictionary)for(var subGeometryData=subGeometryDictionary[key],len=subGeometryData.length,i=0;len>i;i++)subGeometryData[i].dispose(),subGeometryData[i]=null;VertexDataPool._pool[subGeometry.id]=null},VertexDataPool._pool=new Object,VertexDataPool}();pool.VertexDataPool=VertexDataPool}(away.pool||(away.pool={}));away.pool}(away||(away={}));var away;!function(away){!function(stagegl){var AbstractMethodError=away.errors.AbstractMethodError,TextureDataPool=away.pool.TextureDataPool,RenderTexture=away.textures.RenderTexture,ContextGLBase=function(){function ContextGLBase(stageIndex){this._stageIndex=-1,this._antiAlias=0,this._renderTarget=null,this._renderSurfaceSelector=0,this._stageIndex=stageIndex,this._texturePool=new TextureDataPool(this)}return Object.defineProperty(ContextGLBase.prototype,"container",{get:function(){return this._pContainer},enumerable:!0,configurable:!0}),ContextGLBase.prototype.setRenderTarget=function(target,enableDepthAndStencil,surfaceSelector){"undefined"==typeof enableDepthAndStencil&&(enableDepthAndStencil=!1),"undefined"==typeof surfaceSelector&&(surfaceSelector=0),(this._renderTarget!==target||surfaceSelector!=this._renderSurfaceSelector||this._enableDepthAndStencil!=enableDepthAndStencil)&&(this._renderTarget=target,this._renderSurfaceSelector=surfaceSelector,this._enableDepthAndStencil=enableDepthAndStencil,target instanceof RenderTexture?this.setRenderToTexture(this.getRenderTexture(target),enableDepthAndStencil,this._antiAlias,surfaceSelector):(this.setRenderToBackBuffer(),this.configureBackBuffer(this._width,this._height,this._antiAlias,this._enableDepthAndStencil)))},ContextGLBase.prototype.getRenderTexture=function(textureProxy){var textureData=this._texturePool.getItem(textureProxy);return textureData.texture||(textureData.texture=this.createTexture(textureProxy.width,textureProxy.height,stagegl.ContextGLTextureFormat.BGRA,!0)),textureData.texture},ContextGLBase.prototype.activateBuffer=function(index,buffer,offset,format){buffer.contexts[this._stageIndex]||(buffer.contexts[this._stageIndex]=this),buffer.buffers[this._stageIndex]||(buffer.buffers[this._stageIndex]=this.createVertexBuffer(buffer.data.length/buffer.dataPerVertex,buffer.dataPerVertex),buffer.invalid[this._stageIndex]=!0),buffer.invalid[this._stageIndex]&&(buffer.buffers[this._stageIndex].uploadFromArray(buffer.data,0,buffer.data.length/buffer.dataPerVertex),buffer.invalid[this._stageIndex]=!1),this.setVertexBufferAt(index,buffer.buffers[this._stageIndex],offset,format)},ContextGLBase.prototype.disposeVertexData=function(buffer){buffer.buffers[this._stageIndex].dispose(),buffer.buffers[this._stageIndex]=null},ContextGLBase.prototype.activateRenderTexture=function(index,textureProxy){this.setTextureAt(index,this.getRenderTexture(textureProxy))},ContextGLBase.prototype.activateTexture=function(index,textureProxy){var textureData=this._texturePool.getItem(textureProxy);if(textureData.texture||(textureData.texture=this.createTexture(textureProxy.width,textureProxy.height,stagegl.ContextGLTextureFormat.BGRA,!0),textureData.invalid=!0),textureData.invalid)if(textureData.invalid=!1,textureProxy.generateMipmaps)for(var mipmapData=textureProxy._iGetMipmapData(),len=mipmapData.length,i=0;len>i;i++)textureData.texture.uploadFromData(mipmapData[i],i);else textureData.texture.uploadFromData(textureProxy._iGetTextureData(),0);this.setTextureAt(index,textureData.texture)},ContextGLBase.prototype.activateCubeTexture=function(index,textureProxy){var textureData=this._texturePool.getItem(textureProxy);if(textureData.texture||(textureData.texture=this.createCubeTexture(textureProxy.size,stagegl.ContextGLTextureFormat.BGRA,!1),textureData.invalid=!0),textureData.invalid){textureData.invalid=!1;for(var i=0;6>i;++i)if(textureProxy.generateMipmaps)for(var mipmapData=textureProxy._iGetMipmapData(i),len=mipmapData.length,j=0;len>j;j++)textureData.texture.uploadFromData(mipmapData[j],i,j);else textureData.texture.uploadFromData(textureProxy._iGetTextureData(i),i,0)}this.setTextureAt(index,textureData.texture)},ContextGLBase.prototype.getIndexBuffer=function(buffer){return buffer.contexts[this._stageIndex]||(buffer.contexts[this._stageIndex]=this),buffer.buffers[this._stageIndex]||(buffer.buffers[this._stageIndex]=this.createIndexBuffer(buffer.data.length),buffer.invalid[this._stageIndex]=!0),buffer.invalid[this._stageIndex]&&(buffer.buffers[this._stageIndex].uploadFromArray(buffer.data,0,buffer.data.length),buffer.invalid[this._stageIndex]=!1),buffer.buffers[this._stageIndex]},ContextGLBase.prototype.disposeIndexData=function(buffer){buffer.buffers[this._stageIndex].dispose(),buffer.buffers[this._stageIndex]=null},ContextGLBase.prototype.clear=function(red,green,blue,alpha,depth,stencil,mask){"undefined"==typeof red&&(red=0),"undefined"==typeof green&&(green=0),"undefined"==typeof blue&&(blue=0),"undefined"==typeof alpha&&(alpha=1),"undefined"==typeof depth&&(depth=1),"undefined"==typeof stencil&&(stencil=0),"undefined"==typeof mask&&(mask=stagegl.ContextGLClearMask.ALL)},ContextGLBase.prototype.configureBackBuffer=function(width,height,antiAlias,enableDepthAndStencil){"undefined"==typeof enableDepthAndStencil&&(enableDepthAndStencil=!0),this._width=width,this._height=height},ContextGLBase.prototype.createIndexBuffer=function(){throw new AbstractMethodError},ContextGLBase.prototype.createVertexBuffer=function(){throw new AbstractMethodError},ContextGLBase.prototype.createTexture=function(width,height,format,optimizeForRenderToTexture,streamingLevels){throw"undefined"==typeof streamingLevels&&(streamingLevels=0),new AbstractMethodError},ContextGLBase.prototype.createCubeTexture=function(size,format,optimizeForRenderToTexture,streamingLevels){throw"undefined"==typeof streamingLevels&&(streamingLevels=0),new AbstractMethodError},ContextGLBase.prototype.dispose=function(){},ContextGLBase.prototype.present=function(){},ContextGLBase.prototype.setRenderToTexture=function(target,enableDepthAndStencil,antiAlias,surfaceSelector){"undefined"==typeof enableDepthAndStencil&&(enableDepthAndStencil=!1),"undefined"==typeof antiAlias&&(antiAlias=0),"undefined"==typeof surfaceSelector&&(surfaceSelector=0)},ContextGLBase.prototype.setRenderToBackBuffer=function(){},ContextGLBase.prototype.setScissorRectangle=function(){},ContextGLBase.prototype.setTextureAt=function(){},ContextGLBase.prototype.setVertexBufferAt=function(index,buffer,bufferOffset,format){"undefined"==typeof bufferOffset&&(bufferOffset=0),"undefined"==typeof format&&(format=null)},ContextGLBase}();stagegl.ContextGLBase=ContextGLBase}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLClearMask=function(){function ContextGLClearMask(){}return ContextGLClearMask.COLOR=1,ContextGLClearMask.DEPTH=2,ContextGLClearMask.STENCIL=4,ContextGLClearMask.ALL=ContextGLClearMask.COLOR|ContextGLClearMask.DEPTH|ContextGLClearMask.STENCIL,ContextGLClearMask}();stagegl.ContextGLClearMask=ContextGLClearMask}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLTextureFormat=function(){function ContextGLTextureFormat(){}return ContextGLTextureFormat.BGRA="bgra",ContextGLTextureFormat.BGRA_PACKED="bgraPacked4444",ContextGLTextureFormat.BGR_PACKED="bgrPacked565",ContextGLTextureFormat.COMPRESSED="compressed",ContextGLTextureFormat.COMPRESSED_ALPHA="compressedAlpha",ContextGLTextureFormat}();stagegl.ContextGLTextureFormat=ContextGLTextureFormat}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLTriangleFace=function(){function ContextGLTriangleFace(){}return ContextGLTriangleFace.BACK="back",ContextGLTriangleFace.FRONT="front",ContextGLTriangleFace.FRONT_AND_BACK="frontAndBack",ContextGLTriangleFace.NONE="none",ContextGLTriangleFace}();stagegl.ContextGLTriangleFace=ContextGLTriangleFace}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLVertexBufferFormat=function(){function ContextGLVertexBufferFormat(){}return ContextGLVertexBufferFormat.BYTES_4="bytes4",ContextGLVertexBufferFormat.FLOAT_1="float1",ContextGLVertexBufferFormat.FLOAT_2="float2",ContextGLVertexBufferFormat.FLOAT_3="float3",ContextGLVertexBufferFormat.FLOAT_4="float4",ContextGLVertexBufferFormat}();stagegl.ContextGLVertexBufferFormat=ContextGLVertexBufferFormat}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLProgramType=function(){function ContextGLProgramType(){}return ContextGLProgramType.FRAGMENT="fragment",ContextGLProgramType.VERTEX="vertex",ContextGLProgramType}();stagegl.ContextGLProgramType=ContextGLProgramType}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLBlendFactor=function(){function ContextGLBlendFactor(){}return ContextGLBlendFactor.DESTINATION_ALPHA="destinationAlpha",ContextGLBlendFactor.DESTINATION_COLOR="destinationColor",ContextGLBlendFactor.ONE="one",ContextGLBlendFactor.ONE_MINUS_DESTINATION_ALPHA="oneMinusDestinationAlpha",ContextGLBlendFactor.ONE_MINUS_DESTINATION_COLOR="oneMinusDestinationColor",ContextGLBlendFactor.ONE_MINUS_SOURCE_ALPHA="oneMinusSourceAlpha",ContextGLBlendFactor.ONE_MINUS_SOURCE_COLOR="oneMinusSourceColor",ContextGLBlendFactor.SOURCE_ALPHA="sourceAlpha",ContextGLBlendFactor.SOURCE_COLOR="sourceColor",ContextGLBlendFactor.ZERO="zero",ContextGLBlendFactor}();stagegl.ContextGLBlendFactor=ContextGLBlendFactor}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLCompareMode=function(){function ContextGLCompareMode(){}return ContextGLCompareMode.ALWAYS="always",ContextGLCompareMode.EQUAL="equal",ContextGLCompareMode.GREATER="greater",ContextGLCompareMode.GREATER_EQUAL="greaterEqual",ContextGLCompareMode.LESS="less",ContextGLCompareMode.LESS_EQUAL="lessEqual",ContextGLCompareMode.NEVER="never",ContextGLCompareMode.NOT_EQUAL="notEqual",ContextGLCompareMode}();stagegl.ContextGLCompareMode=ContextGLCompareMode}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLMipFilter=function(){function ContextGLMipFilter(){}return ContextGLMipFilter.MIPLINEAR="miplinear",ContextGLMipFilter.MIPNEAREST="mipnearest",ContextGLMipFilter.MIPNONE="mipnone",ContextGLMipFilter}();stagegl.ContextGLMipFilter=ContextGLMipFilter}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLProfile=function(){function ContextGLProfile(){}return ContextGLProfile.BASELINE="baseline",ContextGLProfile.BASELINE_CONSTRAINED="baselineConstrained",ContextGLProfile.BASELINE_EXTENDED="baselineExtended",ContextGLProfile}();stagegl.ContextGLProfile=ContextGLProfile}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLStencilAction=function(){function ContextGLStencilAction(){}return ContextGLStencilAction.DECREMENT_SATURATE="decrementSaturate",ContextGLStencilAction.DECREMENT_WRAP="decrementWrap",ContextGLStencilAction.INCREMENT_SATURATE="incrementSaturate",ContextGLStencilAction.INCREMENT_WRAP="incrementWrap",ContextGLStencilAction.INVERT="invert",ContextGLStencilAction.KEEP="keep",ContextGLStencilAction.SET="set",ContextGLStencilAction.ZERO="zero",ContextGLStencilAction}();stagegl.ContextGLStencilAction=ContextGLStencilAction}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLTextureFilter=function(){function ContextGLTextureFilter(){}return ContextGLTextureFilter.LINEAR="linear",ContextGLTextureFilter.NEAREST="nearest",ContextGLTextureFilter}();stagegl.ContextGLTextureFilter=ContextGLTextureFilter}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextGLWrapMode=function(){function ContextGLWrapMode(){}return ContextGLWrapMode.CLAMP="clamp",ContextGLWrapMode.REPEAT="repeat",ContextGLWrapMode}();stagegl.ContextGLWrapMode=ContextGLWrapMode}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var __extends=this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);__.prototype=b.prototype,d.prototype=new __},away;!function(away){!function(stagegl){var ContextStage3D=function(_super){function ContextStage3D(container,stageIndex,callback){function callbackSWFObject(callbackInfo){callbackInfo.success&&(context3dObj._pContainer=callbackInfo.ref,context3dObj._iCallback=callback)}_super.call(this,stageIndex),this._cmdStream="",this._resources=new Array;var swfVersionStr="11.0.0",flashvars={id:container.id},params={quality:"high",bgcolor:"#ffffff",allowscriptaccess:"sameDomain",allowfullscreen:"true",wmode:"direct"};this._errorCheckingEnabled=!1,this._iDriverInfo="Unknown";var attributes={salign:"tl",id:container.id,name:container.name};this._oldCanvas=container.cloneNode(),this._oldParent=container.parentNode;var context3dObj=this;ContextStage3D.contexts[container.id]=this,swfobject.embedSWF("../libs/molehill_js_flashbridge.swf",container.id,String(container.width),String(container.height),swfVersionStr,"",flashvars,params,attributes,callbackSWFObject)}return __extends(ContextStage3D,_super),Object.defineProperty(ContextStage3D.prototype,"container",{get:function(){return this._pContainer},enumerable:!0,configurable:!0}),Object.defineProperty(ContextStage3D.prototype,"driverInfo",{get:function(){return this._iDriverInfo},enumerable:!0,configurable:!0}),Object.defineProperty(ContextStage3D.prototype,"errorCheckingEnabled",{get:function(){return this._errorCheckingEnabled},set:function(value){this._errorCheckingEnabled!=value&&(this._errorCheckingEnabled=value,this.addStream(String.fromCharCode(away.stagegl.OpCodes.enableErrorChecking,value?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue)),this.execute())},enumerable:!0,configurable:!0}),ContextStage3D.prototype._iAddResource=function(resource){this._resources.push(resource)},ContextStage3D.prototype._iRemoveResource=function(resource){this._resources.splice(this._resources.indexOf(resource))},ContextStage3D.prototype.createTexture=function(width,height,format,optimizeForRenderToTexture,streamingLevels){return"undefined"==typeof streamingLevels&&(streamingLevels=0),new stagegl.TextureFlash(this,width,height,format,optimizeForRenderToTexture)},ContextStage3D.prototype.createCubeTexture=function(size,format,optimizeForRenderToTexture,streamingLevels){return"undefined"==typeof streamingLevels&&(streamingLevels=0),new stagegl.CubeTextureFlash(this,size,format,optimizeForRenderToTexture)},ContextStage3D.prototype.setTextureAt=function(sampler,texture){texture?this.addStream(String.fromCharCode(away.stagegl.OpCodes.setTextureAt)+sampler+","+texture.id+","):this.addStream(String.fromCharCode(away.stagegl.OpCodes.clearTextureAt)+sampler.toString()+","),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setSamplerStateAt=function(){},ContextStage3D.prototype.setStencilActions=function(triangleFace,compareMode,actionOnBothPass,actionOnDepthFail,actionOnDepthPassStencilFail){"undefined"==typeof triangleFace&&(triangleFace="frontAndBack"),"undefined"==typeof compareMode&&(compareMode="always"),"undefined"==typeof actionOnBothPass&&(actionOnBothPass="keep"),"undefined"==typeof actionOnDepthFail&&(actionOnDepthFail="keep"),"undefined"==typeof actionOnDepthPassStencilFail&&(actionOnDepthPassStencilFail="keep"),this.addStream(String.fromCharCode(away.stagegl.OpCodes.setStencilActions)+triangleFace+"$"+compareMode+"$"+actionOnBothPass+"$"+actionOnDepthFail+"$"+actionOnDepthPassStencilFail+"$"),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setStencilReferenceValue=function(referenceValue,readMask,writeMask){"undefined"==typeof readMask&&(readMask=255),"undefined"==typeof writeMask&&(writeMask=255),this.addStream(String.fromCharCode(away.stagegl.OpCodes.setStencilReferenceValue,referenceValue+away.stagegl.OpCodes.intMask,readMask+away.stagegl.OpCodes.intMask,writeMask+away.stagegl.OpCodes.intMask)),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setCulling=function(triangleFaceToCull,coordinateSystem){"undefined"==typeof coordinateSystem&&(coordinateSystem="leftHanded"),this.addStream(String.fromCharCode(away.stagegl.OpCodes.setCulling)+triangleFaceToCull+"$"),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.drawTriangles=function(indexBuffer,firstIndex,numTriangles){"undefined"==typeof firstIndex&&(firstIndex=0),"undefined"==typeof numTriangles&&(numTriangles=-1),firstIndex=firstIndex||0,(!numTriangles||0>numTriangles)&&(numTriangles=indexBuffer.numIndices/3),this.addStream(String.fromCharCode(away.stagegl.OpCodes.drawTriangles,indexBuffer.id+away.stagegl.OpCodes.intMask)+firstIndex+","+numTriangles+","),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setProgramConstantsFromMatrix=function(programType,firstRegister,matrix,transposedMatrix){"undefined"==typeof transposedMatrix&&(transposedMatrix=!1);var d=matrix.rawData;transposedMatrix?(this.setProgramConstantsFromArray(programType,firstRegister,[d[0],d[4],d[8],d[12]],1),this.setProgramConstantsFromArray(programType,firstRegister+1,[d[1],d[5],d[9],d[13]],1),this.setProgramConstantsFromArray(programType,firstRegister+2,[d[2],d[6],d[10],d[14]],1),this.setProgramConstantsFromArray(programType,firstRegister+3,[d[3],d[7],d[11],d[15]],1)):(this.setProgramConstantsFromArray(programType,firstRegister,[d[0],d[1],d[2],d[3]],1),this.setProgramConstantsFromArray(programType,firstRegister+1,[d[4],d[5],d[6],d[7]],1),this.setProgramConstantsFromArray(programType,firstRegister+2,[d[8],d[9],d[10],d[11]],1),this.setProgramConstantsFromArray(programType,firstRegister+3,[d[12],d[13],d[14],d[15]],1))},ContextStage3D.prototype.setProgramConstantsFromArray=function(programType,firstRegister,data,numRegisters){"undefined"==typeof numRegisters&&(numRegisters=-1);for(var startIndex,target=programType==stagegl.ContextGLProgramType.VERTEX?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue,i=0;numRegisters>i;i++)startIndex=4*i,this.addStream(String.fromCharCode(away.stagegl.OpCodes.setProgramConstant,target,firstRegister+i+away.stagegl.OpCodes.intMask)+data[startIndex]+","+data[startIndex+1]+","+data[startIndex+2]+","+data[startIndex+3]+","),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setProgram=function(program){this.addStream(String.fromCharCode(away.stagegl.OpCodes.setProgram,program.id+away.stagegl.OpCodes.intMask)),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.present=function(){this.addStream(String.fromCharCode(away.stagegl.OpCodes.present)),this.execute()},ContextStage3D.prototype.clear=function(red,green,blue,alpha,depth,stencil,mask){"undefined"==typeof red&&(red=0),"undefined"==typeof green&&(green=0),"undefined"==typeof blue&&(blue=0),"undefined"==typeof alpha&&(alpha=1),"undefined"==typeof depth&&(depth=1),"undefined"==typeof stencil&&(stencil=0),"undefined"==typeof mask&&(mask=stagegl.ContextGLClearMask.ALL),this.addStream(String.fromCharCode(away.stagegl.OpCodes.clear)+red+","+green+","+blue+","+alpha+","+depth+","+stencil+","+mask+","),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.createProgram=function(){return new stagegl.ProgramFlash(this)},ContextStage3D.prototype.createVertexBuffer=function(numVertices,data32PerVertex){return new stagegl.VertexBufferFlash(this,numVertices,data32PerVertex)},ContextStage3D.prototype.createIndexBuffer=function(numIndices){return new stagegl.IndexBufferFlash(this,numIndices)},ContextStage3D.prototype.configureBackBuffer=function(width,height,antiAlias,enableDepthAndStencil){"undefined"==typeof enableDepthAndStencil&&(enableDepthAndStencil=!0),_super.prototype.configureBackBuffer.call(this,width,height,antiAlias,enableDepthAndStencil),this.addStream(String.fromCharCode(away.stagegl.OpCodes.configureBackBuffer)+width+","+height+",")},ContextStage3D.prototype.drawToBitmapData=function(){},ContextStage3D.prototype.setVertexBufferAt=function(index,buffer,bufferOffset,format){"undefined"==typeof bufferOffset&&(bufferOffset=0),"undefined"==typeof format&&(format=null),buffer?this.addStream(String.fromCharCode(away.stagegl.OpCodes.setVertexBufferAt,index+away.stagegl.OpCodes.intMask)+buffer.id+","+bufferOffset+","+format+"$"):this.addStream(String.fromCharCode(away.stagegl.OpCodes.clearVertexBufferAt,index+away.stagegl.OpCodes.intMask)),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setColorMask=function(red,green,blue,alpha){this.addStream(String.fromCharCode(away.stagegl.OpCodes.setColorMask,red?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue,green?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue,blue?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue,alpha?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue)),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setBlendFactors=function(sourceFactor,destinationFactor){this.addStream(String.fromCharCode(away.stagegl.OpCodes.setBlendFactors)+sourceFactor+"$"+destinationFactor+"$"),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setRenderToTexture=function(target,enableDepthAndStencil,antiAlias,surfaceSelector){"undefined"==typeof enableDepthAndStencil&&(enableDepthAndStencil=!1),"undefined"==typeof antiAlias&&(antiAlias=0),"undefined"==typeof surfaceSelector&&(surfaceSelector=0),null===target||void 0===target?this.addStream(String.fromCharCode(away.stagegl.OpCodes.clearRenderToTexture)):this.addStream(String.fromCharCode(away.stagegl.OpCodes.setRenderToTexture,enableDepthAndStencil?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue)+target.id+","+(antiAlias||0)+","),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setRenderToBackBuffer=function(){this.addStream(String.fromCharCode(away.stagegl.OpCodes.clearRenderToTexture)),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setScissorRectangle=function(rectangle){rectangle?this.addStream(String.fromCharCode(away.stagegl.OpCodes.setScissorRect)+rectangle.x+","+rectangle.y+","+rectangle.width+","+rectangle.height+","):this.addStream(String.fromCharCode(away.stagegl.OpCodes.clearScissorRect)),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.setDepthTest=function(depthMask,passCompareMode){this.addStream(String.fromCharCode(away.stagegl.OpCodes.setDepthTest,depthMask?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue)+passCompareMode+"$"),ContextStage3D.debug&&this.execute()},ContextStage3D.prototype.dispose=function(){if(null!=this._pContainer){for(console.log("Context3D dispose, releasing "+this._resources.length+" resources.");this._resources.length;)this._resources[0].dispose();this._pContainer&&(this.addStream(String.fromCharCode(away.stagegl.OpCodes.disposeContext)),this.execute(),swfobject.removeSWF(this._oldCanvas.id),this._oldCanvas&&this._oldParent&&(this._oldParent.appendChild(this._oldCanvas),this._oldParent=null),this._pContainer=null),this._oldCanvas=null}},ContextStage3D.prototype.addStream=function(stream){this._cmdStream+=stream},ContextStage3D.prototype.execute=function(){ContextStage3D.logStream&&console.log(this._cmdStream);var result=this._pContainer.CallFunction('<invoke name="execStage3dOpStream" returntype="javascript"><arguments><string>'+this._cmdStream+"</string></arguments></invoke>");if(Number(result)<=-3)throw"Exec stream failed";return this._cmdStream="",Number(result)},ContextStage3D.contexts=new Object,ContextStage3D.maxvertexconstants=128,ContextStage3D.maxfragconstants=28,ContextStage3D.maxtemp=8,ContextStage3D.maxstreams=8,ContextStage3D.maxtextures=8,ContextStage3D.defaultsampler=new aglsl.Sampler,ContextStage3D.debug=!1,ContextStage3D.logStream=!1,ContextStage3D}(stagegl.ContextGLBase);stagegl.ContextStage3D=ContextStage3D}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ContextWebGL=function(_super){function ContextWebGL(canvas,stageIndex){_super.call(this,stageIndex),this._blendFactorDictionary=new Object,this._depthTestDictionary=new Object,this._textureIndexDictionary=new Array(8),this._textureTypeDictionary=new Object,this._wrapDictionary=new Object,this._filterDictionary=new Object,this._mipmapFilterDictionary=new Object,this._uniformLocationNameDictionary=new Object,this._vertexBufferDimensionDictionary=new Object,this._indexBufferList=new Array,this._vertexBufferList=new Array,this._textureList=new Array,this._programList=new Array,this._samplerStates=new Array(8),this._pContainer=canvas;try{this._gl=canvas.getContext("experimental-webgl",{premultipliedAlpha:!1,alpha:!1}),this._gl||(this._gl=canvas.getContext("webgl",{premultipliedAlpha:!1,alpha:!1}))}catch(e){}this._gl?(this._blendFactorDictionary[stagegl.ContextGLBlendFactor.ONE]=this._gl.ONE,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.DESTINATION_ALPHA]=this._gl.DST_ALPHA,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.DESTINATION_COLOR]=this._gl.DST_COLOR,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.ONE]=this._gl.ONE,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.ONE_MINUS_DESTINATION_ALPHA]=this._gl.ONE_MINUS_DST_ALPHA,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.ONE_MINUS_DESTINATION_COLOR]=this._gl.ONE_MINUS_DST_COLOR,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.ONE_MINUS_SOURCE_ALPHA]=this._gl.ONE_MINUS_SRC_ALPHA,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.ONE_MINUS_SOURCE_COLOR]=this._gl.ONE_MINUS_SRC_COLOR,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.SOURCE_ALPHA]=this._gl.SRC_ALPHA,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.SOURCE_COLOR]=this._gl.SRC_COLOR,this._blendFactorDictionary[stagegl.ContextGLBlendFactor.ZERO]=this._gl.ZERO,this._depthTestDictionary[stagegl.ContextGLCompareMode.ALWAYS]=this._gl.ALWAYS,this._depthTestDictionary[stagegl.ContextGLCompareMode.EQUAL]=this._gl.EQUAL,this._depthTestDictionary[stagegl.ContextGLCompareMode.GREATER]=this._gl.GREATER,this._depthTestDictionary[stagegl.ContextGLCompareMode.GREATER_EQUAL]=this._gl.GEQUAL,this._depthTestDictionary[stagegl.ContextGLCompareMode.LESS]=this._gl.LESS,this._depthTestDictionary[stagegl.ContextGLCompareMode.LESS_EQUAL]=this._gl.LEQUAL,this._depthTestDictionary[stagegl.ContextGLCompareMode.NEVER]=this._gl.NEVER,this._depthTestDictionary[stagegl.ContextGLCompareMode.NOT_EQUAL]=this._gl.NOTEQUAL,this._textureIndexDictionary[0]=this._gl.TEXTURE0,this._textureIndexDictionary[1]=this._gl.TEXTURE1,this._textureIndexDictionary[2]=this._gl.TEXTURE2,this._textureIndexDictionary[3]=this._gl.TEXTURE3,this._textureIndexDictionary[4]=this._gl.TEXTURE4,this._textureIndexDictionary[5]=this._gl.TEXTURE5,this._textureIndexDictionary[6]=this._gl.TEXTURE6,this._textureIndexDictionary[7]=this._gl.TEXTURE7,this._textureTypeDictionary.texture2d=this._gl.TEXTURE_2D,this._textureTypeDictionary.textureCube=this._gl.TEXTURE_CUBE_MAP,this._wrapDictionary[stagegl.ContextGLWrapMode.REPEAT]=this._gl.REPEAT,this._wrapDictionary[stagegl.ContextGLWrapMode.CLAMP]=this._gl.CLAMP_TO_EDGE,this._filterDictionary[stagegl.ContextGLTextureFilter.LINEAR]=this._gl.LINEAR,this._filterDictionary[stagegl.ContextGLTextureFilter.NEAREST]=this._gl.NEAREST,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.LINEAR]=new Object,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.LINEAR][stagegl.ContextGLMipFilter.MIPNEAREST]=this._gl.LINEAR_MIPMAP_NEAREST,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.LINEAR][stagegl.ContextGLMipFilter.MIPLINEAR]=this._gl.LINEAR_MIPMAP_LINEAR,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.LINEAR][stagegl.ContextGLMipFilter.MIPNONE]=this._gl.LINEAR,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.NEAREST]=new Object,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.NEAREST][stagegl.ContextGLMipFilter.MIPNEAREST]=this._gl.NEAREST_MIPMAP_NEAREST,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.NEAREST][stagegl.ContextGLMipFilter.MIPLINEAR]=this._gl.NEAREST_MIPMAP_LINEAR,this._mipmapFilterDictionary[stagegl.ContextGLTextureFilter.NEAREST][stagegl.ContextGLMipFilter.MIPNONE]=this._gl.NEAREST,this._uniformLocationNameDictionary[stagegl.ContextGLProgramType.VERTEX]="vc",this._uniformLocationNameDictionary[stagegl.ContextGLProgramType.FRAGMENT]="fc",this._vertexBufferDimensionDictionary[stagegl.ContextGLVertexBufferFormat.FLOAT_1]=1,this._vertexBufferDimensionDictionary[stagegl.ContextGLVertexBufferFormat.FLOAT_2]=2,this._vertexBufferDimensionDictionary[stagegl.ContextGLVertexBufferFormat.FLOAT_3]=3,this._vertexBufferDimensionDictionary[stagegl.ContextGLVertexBufferFormat.FLOAT_4]=4,this._vertexBufferDimensionDictionary[stagegl.ContextGLVertexBufferFormat.BYTES_4]=4):alert("WebGL is not available.");for(var i=0;i<ContextWebGL.MAX_SAMPLERS;++i)this._samplerStates[i]=new stagegl.SamplerState,this._samplerStates[i].wrap=this._gl.REPEAT,this._samplerStates[i].filter=this._gl.LINEAR,this._samplerStates[i].mipfilter=this._gl.LINEAR}return __extends(ContextWebGL,_super),Object.defineProperty(ContextWebGL.prototype,"container",{get:function(){return this._pContainer},enumerable:!0,configurable:!0}),ContextWebGL.prototype.gl=function(){return this._gl},ContextWebGL.prototype.clear=function(red,green,blue,alpha,depth,stencil,mask){"undefined"==typeof red&&(red=0),"undefined"==typeof green&&(green=0),"undefined"==typeof blue&&(blue=0),"undefined"==typeof alpha&&(alpha=1),"undefined"==typeof depth&&(depth=1),"undefined"==typeof stencil&&(stencil=0),"undefined"==typeof mask&&(mask=stagegl.ContextGLClearMask.ALL),this._drawing||(this.updateBlendStatus(),this._drawing=!0);var glmask=0;mask&stagegl.ContextGLClearMask.COLOR&&(glmask|=this._gl.COLOR_BUFFER_BIT),mask&stagegl.ContextGLClearMask.STENCIL&&(glmask|=this._gl.STENCIL_BUFFER_BIT),mask&stagegl.ContextGLClearMask.DEPTH&&(glmask|=this._gl.DEPTH_BUFFER_BIT),this._gl.clearColor(red,green,blue,alpha),this._gl.clearDepth(depth),this._gl.clearStencil(stencil),this._gl.clear(glmask)
},ContextWebGL.prototype.configureBackBuffer=function(width,height,antiAlias,enableDepthAndStencil){"undefined"==typeof enableDepthAndStencil&&(enableDepthAndStencil=!0),_super.prototype.configureBackBuffer.call(this,width,height,antiAlias,enableDepthAndStencil),enableDepthAndStencil&&(this._gl.enable(this._gl.STENCIL_TEST),this._gl.enable(this._gl.DEPTH_TEST)),this._gl.viewport.width=width,this._gl.viewport.height=height,this._gl.viewport(0,0,width,height)},ContextWebGL.prototype.createCubeTexture=function(size,format,optimizeForRenderToTexture,streamingLevels){"undefined"==typeof streamingLevels&&(streamingLevels=0);var texture=new stagegl.CubeTextureWebGL(this._gl,size);return this._textureList.push(texture),texture},ContextWebGL.prototype.createIndexBuffer=function(numIndices){var indexBuffer=new stagegl.IndexBufferWebGL(this._gl,numIndices);return this._indexBufferList.push(indexBuffer),indexBuffer},ContextWebGL.prototype.createProgram=function(){var program=new stagegl.ProgramWebGL(this._gl);return this._programList.push(program),program},ContextWebGL.prototype.createTexture=function(width,height,format,optimizeForRenderToTexture,streamingLevels){"undefined"==typeof streamingLevels&&(streamingLevels=0);var texture=new stagegl.TextureWebGL(this._gl,width,height);return this._textureList.push(texture),texture},ContextWebGL.prototype.createVertexBuffer=function(numVertices,data32PerVertex){var vertexBuffer=new stagegl.VertexBufferWebGL(this._gl,numVertices,data32PerVertex);return this._vertexBufferList.push(vertexBuffer),vertexBuffer},ContextWebGL.prototype.dispose=function(){var i;for(i=0;i<this._indexBufferList.length;++i)this._indexBufferList[i].dispose();for(this._indexBufferList=null,i=0;i<this._vertexBufferList.length;++i)this._vertexBufferList[i].dispose();for(this._vertexBufferList=null,i=0;i<this._textureList.length;++i)this._textureList[i].dispose();for(this._textureList=null,i=0;i<this._programList.length;++i)this._programList[i].dispose();for(i=0;i<this._samplerStates.length;++i)this._samplerStates[i]=null;this._programList=null},ContextWebGL.prototype.drawToBitmapData=function(destination){var arrayBuffer=new ArrayBuffer(destination.width*destination.height*4);this._gl.readPixels(0,0,destination.width,destination.height,this._gl.RGBA,this._gl.UNSIGNED_BYTE,new Uint8Array(arrayBuffer));var byteArray=new away.utils.ByteArray;byteArray.setArrayBuffer(arrayBuffer),destination.setPixels(new away.geom.Rectangle(0,0,destination.width,destination.height),byteArray)},ContextWebGL.prototype.drawTriangles=function(indexBuffer,firstIndex,numTriangles){if("undefined"==typeof firstIndex&&(firstIndex=0),"undefined"==typeof numTriangles&&(numTriangles=-1),!this._drawing)throw"Need to clear before drawing if the buffer has not been cleared since the last present() call.";this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,indexBuffer.glBuffer),this._gl.drawElements(this._gl.TRIANGLES,-1==numTriangles?indexBuffer.numIndices:3*numTriangles,this._gl.UNSIGNED_SHORT,firstIndex)},ContextWebGL.prototype.present=function(){this._drawing=!1},ContextWebGL.prototype.setBlendFactors=function(sourceFactor,destinationFactor){this._blendEnabled=!0,this._blendSourceFactor=this._blendFactorDictionary[sourceFactor],this._blendDestinationFactor=this._blendFactorDictionary[destinationFactor],this.updateBlendStatus()},ContextWebGL.prototype.setColorMask=function(red,green,blue,alpha){this._gl.colorMask(red,green,blue,alpha)},ContextWebGL.prototype.setCulling=function(triangleFaceToCull,coordinateSystem){if("undefined"==typeof coordinateSystem&&(coordinateSystem="leftHanded"),triangleFaceToCull==stagegl.ContextGLTriangleFace.NONE)this._gl.disable(this._gl.CULL_FACE);else switch(this._gl.enable(this._gl.CULL_FACE),triangleFaceToCull){case stagegl.ContextGLTriangleFace.BACK:this._gl.cullFace("leftHanded"==coordinateSystem?this._gl.FRONT:this._gl.BACK);break;case stagegl.ContextGLTriangleFace.FRONT:this._gl.cullFace("leftHanded"==coordinateSystem?this._gl.BACK:this._gl.FRONT);break;case stagegl.ContextGLTriangleFace.FRONT_AND_BACK:this._gl.cullFace(this._gl.FRONT_AND_BACK);break;default:throw"Unknown ContextGLTriangleFace type."}},ContextWebGL.prototype.setDepthTest=function(depthMask,passCompareMode){this._gl.depthFunc(this._depthTestDictionary[passCompareMode]),this._gl.depthMask(depthMask)},ContextWebGL.prototype.setProgram=function(program){this._currentProgram=program,program.focusProgram()},ContextWebGL.prototype.setProgramConstantsFromMatrix=function(programType,firstRegister,matrix,transposedMatrix){"undefined"==typeof transposedMatrix&&(transposedMatrix=!1);var d=matrix.rawData;transposedMatrix?(this.setProgramConstantsFromArray(programType,firstRegister,[d[0],d[4],d[8],d[12]],1),this.setProgramConstantsFromArray(programType,firstRegister+1,[d[1],d[5],d[9],d[13]],1),this.setProgramConstantsFromArray(programType,firstRegister+2,[d[2],d[6],d[10],d[14]],1),this.setProgramConstantsFromArray(programType,firstRegister+3,[d[3],d[7],d[11],d[15]],1)):(this.setProgramConstantsFromArray(programType,firstRegister,[d[0],d[1],d[2],d[3]],1),this.setProgramConstantsFromArray(programType,firstRegister+1,[d[4],d[5],d[6],d[7]],1),this.setProgramConstantsFromArray(programType,firstRegister+2,[d[8],d[9],d[10],d[11]],1),this.setProgramConstantsFromArray(programType,firstRegister+3,[d[12],d[13],d[14],d[15]],1))},ContextWebGL.prototype.setProgramConstantsFromArray=function(programType,firstRegister,data,numRegisters){"undefined"==typeof numRegisters&&(numRegisters=-1);for(var startIndex,locationName=this._uniformLocationNameDictionary[programType],i=0;numRegisters>i;i++)startIndex=4*i,this._gl.uniform4f(this._gl.getUniformLocation(this._currentProgram.glProgram,locationName+(firstRegister+i)),data[startIndex],data[startIndex+1],data[startIndex+2],data[startIndex+3])},ContextWebGL.prototype.setScissorRectangle=function(rectangle){return rectangle?(this._gl.enable(this._gl.SCISSOR_TEST),this._gl.scissor(rectangle.x,rectangle.y,rectangle.width,rectangle.height),void 0):(this._gl.disable(this._gl.SCISSOR_TEST),void 0)},ContextWebGL.prototype.setTextureAt=function(sampler,texture){var samplerState=this._samplerStates[sampler];if(this._activeTexture!=sampler&&(texture||samplerState.type)&&(this._activeTexture=sampler,this._gl.activeTexture(this._textureIndexDictionary[sampler])),!texture)return samplerState.type&&(this._gl.bindTexture(samplerState.type,null),samplerState.type=null),void 0;var textureType=this._textureTypeDictionary[texture.textureType];samplerState.type=textureType,this._gl.bindTexture(textureType,texture.glTexture),this._gl.uniform1i(this._gl.getUniformLocation(this._currentProgram.glProgram,"fs"+sampler),sampler),this._gl.texParameteri(textureType,this._gl.TEXTURE_WRAP_S,samplerState.wrap),this._gl.texParameteri(textureType,this._gl.TEXTURE_WRAP_T,samplerState.wrap),this._gl.texParameteri(textureType,this._gl.TEXTURE_MAG_FILTER,samplerState.filter),this._gl.texParameteri(textureType,this._gl.TEXTURE_MIN_FILTER,samplerState.mipfilter)},ContextWebGL.prototype.setSamplerStateAt=function(sampler,wrap,filter,mipfilter){if(!(sampler>=0&&sampler<ContextWebGL.MAX_SAMPLERS))throw"Sampler is out of bounds.";this._samplerStates[sampler].wrap=this._wrapDictionary[wrap],this._samplerStates[sampler].filter=this._filterDictionary[filter],this._samplerStates[sampler].mipfilter=this._mipmapFilterDictionary[filter][mipfilter]},ContextWebGL.prototype.setVertexBufferAt=function(index,buffer,bufferOffset,format){"undefined"==typeof bufferOffset&&(bufferOffset=0),"undefined"==typeof format&&(format=null);var location=this._currentProgram?this._gl.getAttribLocation(this._currentProgram.glProgram,"va"+index):-1;return buffer?(this._gl.bindBuffer(this._gl.ARRAY_BUFFER,buffer.glBuffer),this._gl.enableVertexAttribArray(location),this._gl.vertexAttribPointer(location,this._vertexBufferDimensionDictionary[format],this._gl.FLOAT,!1,4*buffer.data32PerVertex,4*bufferOffset),void 0):(location>-1&&this._gl.disableVertexAttribArray(location),void 0)},ContextWebGL.prototype.setRenderToTexture=function(target,enableDepthAndStencil,antiAlias,surfaceSelector){"undefined"==typeof enableDepthAndStencil&&(enableDepthAndStencil=!1),"undefined"==typeof antiAlias&&(antiAlias=0),"undefined"==typeof surfaceSelector&&(surfaceSelector=0);var texture=target,frameBuffer=texture.frameBuffer;this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,frameBuffer),enableDepthAndStencil&&(this._gl.enable(this._gl.STENCIL_TEST),this._gl.enable(this._gl.DEPTH_TEST)),this._gl.viewport(0,0,texture.width,texture.height)},ContextWebGL.prototype.setRenderToBackBuffer=function(){this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,null)},ContextWebGL.prototype.updateBlendStatus=function(){this._blendEnabled?(this._gl.enable(this._gl.BLEND),this._gl.blendEquation(this._gl.FUNC_ADD),this._gl.blendFunc(this._blendSourceFactor,this._blendDestinationFactor)):this._gl.disable(this._gl.BLEND)},ContextWebGL.MAX_SAMPLERS=8,ContextWebGL.modulo=0,ContextWebGL}(stagegl.ContextGLBase);stagegl.ContextWebGL=ContextWebGL}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ResourceBaseFlash=function(){function ResourceBaseFlash(){}return Object.defineProperty(ResourceBaseFlash.prototype,"id",{get:function(){return this._pId},enumerable:!0,configurable:!0}),ResourceBaseFlash.prototype.dispose=function(){},ResourceBaseFlash}();stagegl.ResourceBaseFlash=ResourceBaseFlash}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var TextureBaseWebGL=function(){function TextureBaseWebGL(gl){this.textureType="",this._gl=gl}return TextureBaseWebGL.prototype.dispose=function(){throw"Abstract method must be overridden."},Object.defineProperty(TextureBaseWebGL.prototype,"glTexture",{get:function(){throw new away.errors.AbstractMethodError},enumerable:!0,configurable:!0}),TextureBaseWebGL}();stagegl.TextureBaseWebGL=TextureBaseWebGL}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ByteArrayBase=away.utils.ByteArrayBase,CubeTextureFlash=function(_super){function CubeTextureFlash(context,size,format,forRTT,streaming){"undefined"==typeof streaming&&(streaming=!1),_super.call(this),this._context=context,this._size=size,this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.initCubeTexture,forRTT?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue)+size+","+streaming+","+format+"$"),this._pId=this._context.execute(),this._context._iAddResource(this)}return __extends(CubeTextureFlash,_super),Object.defineProperty(CubeTextureFlash.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0}),CubeTextureFlash.prototype.dispose=function(){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.disposeCubeTexture)+this._pId.toString()+","),this._context.execute(),this._context._iRemoveResource(this),this._context=null},CubeTextureFlash.prototype.uploadFromData=function(data,side,miplevel){if("undefined"==typeof miplevel&&(miplevel=0),data instanceof away.base.BitmapData)data=data.imageData.data;else if(data instanceof HTMLImageElement){var can=document.createElement("canvas"),w=data.width,h=data.height;can.width=w,can.height=h;var ctx=can.getContext("2d");ctx.drawImage(data,0,0),data=ctx.getImageData(0,0,w,h).data}var pos=0,bytes=ByteArrayBase.internalGetBase64String(data.length,function(){return data[pos++]},null);this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.uploadBytesCubeTexture)+this._pId+","+miplevel+","+side+","+(this.size>>miplevel)+","+bytes+"%"),this._context.execute()},CubeTextureFlash.prototype.uploadCompressedTextureFromByteArray=function(data,byteArrayOffset,async){"undefined"==typeof async&&(async=!1)},CubeTextureFlash}(stagegl.ResourceBaseFlash);stagegl.CubeTextureFlash=CubeTextureFlash}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var CubeTextureWebGL=function(_super){function CubeTextureWebGL(gl,size){_super.call(this,gl),this._textureSelectorDictionary=new Array(6),this.textureType="textureCube",this._size=size,this._texture=this._gl.createTexture(),this._textureSelectorDictionary[0]=gl.TEXTURE_CUBE_MAP_POSITIVE_X,this._textureSelectorDictionary[1]=gl.TEXTURE_CUBE_MAP_NEGATIVE_X,this._textureSelectorDictionary[2]=gl.TEXTURE_CUBE_MAP_POSITIVE_Y,this._textureSelectorDictionary[3]=gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,this._textureSelectorDictionary[4]=gl.TEXTURE_CUBE_MAP_POSITIVE_Z,this._textureSelectorDictionary[5]=gl.TEXTURE_CUBE_MAP_NEGATIVE_Z}return __extends(CubeTextureWebGL,_super),CubeTextureWebGL.prototype.dispose=function(){this._gl.deleteTexture(this._texture)},CubeTextureWebGL.prototype.uploadFromData=function(data,side,miplevel){"undefined"==typeof miplevel&&(miplevel=0),data instanceof away.base.BitmapData&&(data=data.imageData),this._gl.bindTexture(this._gl.TEXTURE_CUBE_MAP,this._texture),this._gl.texImage2D(this._textureSelectorDictionary[side],miplevel,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,data),this._gl.bindTexture(this._gl.TEXTURE_CUBE_MAP,null)},CubeTextureWebGL.prototype.uploadCompressedTextureFromByteArray=function(data,byteArrayOffset,async){"undefined"==typeof async&&(async=!1)},Object.defineProperty(CubeTextureWebGL.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0}),Object.defineProperty(CubeTextureWebGL.prototype,"glTexture",{get:function(){return this._texture},enumerable:!0,configurable:!0}),CubeTextureWebGL}(stagegl.TextureBaseWebGL);stagegl.CubeTextureWebGL=CubeTextureWebGL}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(){}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var IndexBufferFlash=function(_super){function IndexBufferFlash(context,numIndices){_super.call(this),this._context=context,this._numIndices=numIndices,this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.initIndexBuffer,numIndices+away.stagegl.OpCodes.intMask)),this._pId=this._context.execute(),this._context._iAddResource(this)}return __extends(IndexBufferFlash,_super),IndexBufferFlash.prototype.uploadFromArray=function(data,startOffset,count){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.uploadArrayIndexBuffer,this._pId+away.stagegl.OpCodes.intMask)+data.join()+"#"+startOffset+","+count+","),this._context.execute()},IndexBufferFlash.prototype.dispose=function(){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.disposeIndexBuffer,this._pId+away.stagegl.OpCodes.intMask)),this._context.execute(),this._context._iRemoveResource(this),this._context=null},Object.defineProperty(IndexBufferFlash.prototype,"numIndices",{get:function(){return this._numIndices},enumerable:!0,configurable:!0}),IndexBufferFlash}(stagegl.ResourceBaseFlash);stagegl.IndexBufferFlash=IndexBufferFlash}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var IndexBufferWebGL=function(){function IndexBufferWebGL(gl,numIndices){this._gl=gl,this._buffer=this._gl.createBuffer(),this._numIndices=numIndices}return IndexBufferWebGL.prototype.uploadFromArray=function(data){this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,this._buffer),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(data),this._gl.STATIC_DRAW)},IndexBufferWebGL.prototype.dispose=function(){this._gl.deleteBuffer(this._buffer)},Object.defineProperty(IndexBufferWebGL.prototype,"numIndices",{get:function(){return this._numIndices},enumerable:!0,configurable:!0}),Object.defineProperty(IndexBufferWebGL.prototype,"glBuffer",{get:function(){return this._buffer},enumerable:!0,configurable:!0}),IndexBufferWebGL}();stagegl.IndexBufferWebGL=IndexBufferWebGL}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(){}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var OpCodes=function(){function OpCodes(){}return OpCodes.trueValue=32,OpCodes.falseValue=33,OpCodes.intMask=63,OpCodes.drawTriangles=41,OpCodes.setProgramConstant=42,OpCodes.setProgram=43,OpCodes.present=44,OpCodes.clear=45,OpCodes.initProgram=46,OpCodes.initVertexBuffer=47,OpCodes.initIndexBuffer=48,OpCodes.configureBackBuffer=49,OpCodes.uploadArrayIndexBuffer=50,OpCodes.uploadArrayVertexBuffer=51,OpCodes.uploadAGALBytesProgram=52,OpCodes.setVertexBufferAt=53,OpCodes.uploadBytesIndexBuffer=54,OpCodes.uploadBytesVertexBuffer=55,OpCodes.setColorMask=56,OpCodes.setDepthTest=57,OpCodes.disposeProgram=58,OpCodes.disposeContext=59,OpCodes.disposeVertexBuffer=61,OpCodes.disposeIndexBuffer=63,OpCodes.initTexture=64,OpCodes.setTextureAt=65,OpCodes.uploadBytesTexture=66,OpCodes.disposeTexture=67,OpCodes.setCulling=68,OpCodes.setScissorRect=69,OpCodes.clearScissorRect=70,OpCodes.setBlendFactors=71,OpCodes.setRenderToTexture=72,OpCodes.clearTextureAt=73,OpCodes.clearVertexBufferAt=74,OpCodes.setStencilActions=75,OpCodes.setStencilReferenceValue=76,OpCodes.initCubeTexture=77,OpCodes.disposeCubeTexture=78,OpCodes.uploadBytesCubeTexture=79,OpCodes.clearRenderToTexture=80,OpCodes.enableErrorChecking=81,OpCodes}();stagegl.OpCodes=OpCodes}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ProgramFlash=function(_super){function ProgramFlash(context){_super.call(this),this._context=context,this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.initProgram)),this._pId=this._context.execute(),this._context._iAddResource(this)}return __extends(ProgramFlash,_super),ProgramFlash.prototype.upload=function(vertexProgram,fragmentProgram){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.uploadAGALBytesProgram,this._pId+away.stagegl.OpCodes.intMask)+vertexProgram.readBase64String(vertexProgram.length)+"%"+fragmentProgram.readBase64String(fragmentProgram.length)+"%"),stagegl.ContextStage3D.debug&&this._context.execute()},ProgramFlash.prototype.dispose=function(){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.disposeProgram,this._pId+away.stagegl.OpCodes.intMask)),this._context.execute(),this._context._iRemoveResource(this),this._context=null},ProgramFlash}(stagegl.ResourceBaseFlash);stagegl.ProgramFlash=ProgramFlash}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ProgramWebGL=function(){function ProgramWebGL(gl){this._gl=gl,this._program=this._gl.createProgram()}return ProgramWebGL.prototype.upload=function(vertexProgram,fragmentProgram){var vertexString=ProgramWebGL._aglslParser.parse(ProgramWebGL._tokenizer.decribeAGALByteArray(vertexProgram)),fragmentString=ProgramWebGL._aglslParser.parse(ProgramWebGL._tokenizer.decribeAGALByteArray(fragmentProgram));return this._vertexShader=this._gl.createShader(this._gl.VERTEX_SHADER),this._fragmentShader=this._gl.createShader(this._gl.FRAGMENT_SHADER),this._gl.shaderSource(this._vertexShader,vertexString),this._gl.compileShader(this._vertexShader),this._gl.getShaderParameter(this._vertexShader,this._gl.COMPILE_STATUS)?(this._gl.shaderSource(this._fragmentShader,fragmentString),this._gl.compileShader(this._fragmentShader),this._gl.getShaderParameter(this._fragmentShader,this._gl.COMPILE_STATUS)?(this._gl.attachShader(this._program,this._vertexShader),this._gl.attachShader(this._program,this._fragmentShader),this._gl.linkProgram(this._program),this._gl.getProgramParameter(this._program,this._gl.LINK_STATUS)||alert("Could not link the program."),void 0):(alert(this._gl.getShaderInfoLog(this._fragmentShader)),null)):(alert(this._gl.getShaderInfoLog(this._vertexShader)),null)},ProgramWebGL.prototype.dispose=function(){this._gl.deleteProgram(this._program)},ProgramWebGL.prototype.focusProgram=function(){this._gl.useProgram(this._program)},Object.defineProperty(ProgramWebGL.prototype,"glProgram",{get:function(){return this._program},enumerable:!0,configurable:!0}),ProgramWebGL._tokenizer=new aglsl.AGALTokenizer,ProgramWebGL._aglslParser=new aglsl.AGLSLParser,ProgramWebGL}();stagegl.ProgramWebGL=ProgramWebGL}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var SamplerState=function(){function SamplerState(){}return SamplerState}();stagegl.SamplerState=SamplerState}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var ByteArrayBase=away.utils.ByteArrayBase,TextureFlash=function(_super){function TextureFlash(context,width,height,format,forRTT,streaming){"undefined"==typeof streaming&&(streaming=!1),_super.call(this),this._context=context,this._width=width,this._height=height,this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.initTexture,forRTT?away.stagegl.OpCodes.trueValue:away.stagegl.OpCodes.falseValue)+width+","+height+","+streaming+","+format+"$"),this._pId=this._context.execute(),this._context._iAddResource(this)}return __extends(TextureFlash,_super),Object.defineProperty(TextureFlash.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(TextureFlash.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),TextureFlash.prototype.dispose=function(){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.disposeTexture)+this._pId.toString()+","),this._context.execute(),this._context._iRemoveResource(this),this._context=null},TextureFlash.prototype.uploadFromData=function(data,miplevel){if("undefined"==typeof miplevel&&(miplevel=0),data instanceof away.base.BitmapData)data=data.imageData.data;else if(data instanceof HTMLImageElement){var can=document.createElement("canvas"),w=data.width,h=data.height;can.width=w,can.height=h;var ctx=can.getContext("2d");ctx.drawImage(data,0,0),data=ctx.getImageData(0,0,w,h).data}var pos=0,bytes=ByteArrayBase.internalGetBase64String(data.length,function(){return data[pos++]},null);this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.uploadBytesTexture)+this._pId+","+miplevel+","+(this._width>>miplevel)+","+(this._height>>miplevel)+","+bytes+"%"),this._context.execute()},TextureFlash}(stagegl.ResourceBaseFlash);stagegl.TextureFlash=TextureFlash}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var TextureWebGL=function(_super){function TextureWebGL(gl,width,height){_super.call(this,gl),this.textureType="texture2d",this._width=width,this._height=height,this._glTexture=this._gl.createTexture()}return __extends(TextureWebGL,_super),TextureWebGL.prototype.dispose=function(){this._gl.deleteTexture(this._glTexture)},Object.defineProperty(TextureWebGL.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(TextureWebGL.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(TextureWebGL.prototype,"frameBuffer",{get:function(){if(!this._frameBuffer){this._frameBuffer=this._gl.createFramebuffer(),this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,this._frameBuffer),this._gl.bindTexture(this._gl.TEXTURE_2D,this._glTexture),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._width,this._height,0,this._gl.RGBA,this._gl.UNSIGNED_BYTE,null);var renderBuffer=this._gl.createRenderbuffer();this._gl.bindRenderbuffer(this._gl.RENDERBUFFER,renderBuffer),this._gl.renderbufferStorage(this._gl.RENDERBUFFER,this._gl.DEPTH_COMPONENT16,this._width,this._height),this._gl.framebufferTexture2D(this._gl.FRAMEBUFFER,this._gl.COLOR_ATTACHMENT0,this._gl.TEXTURE_2D,this._glTexture,0),this._gl.framebufferRenderbuffer(this._gl.FRAMEBUFFER,this._gl.DEPTH_ATTACHMENT,this._gl.RENDERBUFFER,renderBuffer),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._gl.bindRenderbuffer(this._gl.RENDERBUFFER,null),this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,null)}return this._frameBuffer},enumerable:!0,configurable:!0}),TextureWebGL.prototype.uploadFromData=function(data,miplevel){"undefined"==typeof miplevel&&(miplevel=0),data instanceof away.base.BitmapData&&(data=data.imageData),this._gl.bindTexture(this._gl.TEXTURE_2D,this._glTexture),this._gl.texImage2D(this._gl.TEXTURE_2D,miplevel,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,data),this._gl.bindTexture(this._gl.TEXTURE_2D,null)},TextureWebGL.prototype.uploadCompressedTextureFromByteArray=function(data,byteArrayOffset,async){"undefined"==typeof async&&(async=!1);this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")},Object.defineProperty(TextureWebGL.prototype,"glTexture",{get:function(){return this._glTexture},enumerable:!0,configurable:!0}),TextureWebGL.prototype.generateMipmaps=function(){},TextureWebGL}(stagegl.TextureBaseWebGL);stagegl.TextureWebGL=TextureWebGL}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var VertexBufferFlash=function(_super){function VertexBufferFlash(context,numVertices,data32PerVertex){_super.call(this),this._context=context,this._numVertices=numVertices,this._data32PerVertex=data32PerVertex,this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.initVertexBuffer,data32PerVertex+away.stagegl.OpCodes.intMask)+numVertices.toString()+","),this._pId=this._context.execute(),this._context._iAddResource(this)}return __extends(VertexBufferFlash,_super),VertexBufferFlash.prototype.uploadFromArray=function(data,startVertex,numVertices){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.uploadArrayVertexBuffer,this._pId+away.stagegl.OpCodes.intMask)+data.join()+"#"+[startVertex,numVertices].join()+","),this._context.execute()},Object.defineProperty(VertexBufferFlash.prototype,"numVertices",{get:function(){return this._numVertices},enumerable:!0,configurable:!0}),Object.defineProperty(VertexBufferFlash.prototype,"data32PerVertex",{get:function(){return this._data32PerVertex},enumerable:!0,configurable:!0}),VertexBufferFlash.prototype.dispose=function(){this._context.addStream(String.fromCharCode(away.stagegl.OpCodes.disposeVertexBuffer,this._pId+away.stagegl.OpCodes.intMask)),this._context.execute(),this._context._iRemoveResource(this),this._context=null},VertexBufferFlash}(stagegl.ResourceBaseFlash);stagegl.VertexBufferFlash=VertexBufferFlash}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(stagegl){var VertexBufferWebGL=function(){function VertexBufferWebGL(gl,numVertices,data32PerVertex){this._gl=gl,this._buffer=this._gl.createBuffer(),this._numVertices=numVertices,this._data32PerVertex=data32PerVertex}return VertexBufferWebGL.prototype.uploadFromArray=function(vertices){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._buffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(vertices),this._gl.STATIC_DRAW)},Object.defineProperty(VertexBufferWebGL.prototype,"numVertices",{get:function(){return this._numVertices},enumerable:!0,configurable:!0}),Object.defineProperty(VertexBufferWebGL.prototype,"data32PerVertex",{get:function(){return this._data32PerVertex},enumerable:!0,configurable:!0}),Object.defineProperty(VertexBufferWebGL.prototype,"glBuffer",{get:function(){return this._buffer},enumerable:!0,configurable:!0}),VertexBufferWebGL.prototype.dispose=function(){this._gl.deleteBuffer(this._buffer)},VertexBufferWebGL}();stagegl.VertexBufferWebGL=VertexBufferWebGL}(away.stagegl||(away.stagegl={}));away.stagegl}(away||(away={}));var away;!function(away){!function(managers){var StageEvent=away.events.StageEvent,AGALProgramCache=function(){function AGALProgramCache(stage,agalProgramCacheSingletonEnforcer){if(!agalProgramCacheSingletonEnforcer)throw new Error("This class is a multiton and cannot be instantiated manually. Use StageManager.getInstance instead.");this._stage=stage,this._program3Ds=new Object,this._ids=new Object,this._usages=new Object,this._keys=new Object}return AGALProgramCache.getInstance=function(stage){var index=stage.stageIndex;return null==AGALProgramCache._instances&&(AGALProgramCache._instances=new Array(8)),AGALProgramCache._instances[index]||(AGALProgramCache._instances[index]=new AGALProgramCache(stage,new AGALProgramCacheSingletonEnforcer),stage.addEventListener(StageEvent.CONTEXT_DISPOSED,AGALProgramCache.onContextGLDisposed),stage.addEventListener(StageEvent.CONTEXT_CREATED,AGALProgramCache.onContextGLDisposed),stage.addEventListener(StageEvent.CONTEXT_RECREATED,AGALProgramCache.onContextGLDisposed)),AGALProgramCache._instances[index]},AGALProgramCache.getInstanceFromIndex=function(index){if(!AGALProgramCache._instances[index])throw new Error("Instance not created yet!");return AGALProgramCache._instances[index]},AGALProgramCache.onContextGLDisposed=function(event){var stage=event.target,index=stage.stageIndex;AGALProgramCache._instances[index].dispose(),AGALProgramCache._instances[index]=null,stage.removeEventListener(StageEvent.CONTEXT_DISPOSED,AGALProgramCache.onContextGLDisposed),stage.removeEventListener(StageEvent.CONTEXT_CREATED,AGALProgramCache.onContextGLDisposed),stage.removeEventListener(StageEvent.CONTEXT_RECREATED,AGALProgramCache.onContextGLDisposed)},AGALProgramCache.prototype.dispose=function(){for(var key in this._program3Ds)this.destroyProgram(key);this._keys=null,this._program3Ds=null,this._usages=null},AGALProgramCache.prototype.setProgram=function(programIds,programs,vertexCode,fragmentCode){var program,stageIndex=this._stage.stageIndex,key=this.getKey(vertexCode,fragmentCode);if(null==this._program3Ds[key]){this._keys[AGALProgramCache._currentId]=key,this._usages[AGALProgramCache._currentId]=0,this._ids[key]=AGALProgramCache._currentId,++AGALProgramCache._currentId,program=this._stage.context.createProgram();var vertexByteCode=(new aglsl.assembler.AGALMiniAssembler).assemble("part vertex 1\n"+vertexCode+"endpart").vertex.data,fragmentByteCode=(new aglsl.assembler.AGALMiniAssembler).assemble("part fragment 1\n"+fragmentCode+"endpart").fragment.data;program.upload(vertexByteCode,fragmentByteCode),this._program3Ds[key]=program}var oldId=programIds[stageIndex],newId=this._ids[key];oldId!=newId&&(oldId>=0&&this.freeProgram(oldId),this._usages[newId]++),programIds[stageIndex]=newId,programs[stageIndex]=this._program3Ds[key]},AGALProgramCache.prototype.freeProgram=function(programId){this._usages[programId]--,0==this._usages[programId]&&this.destroyProgram(this._keys[programId])},AGALProgramCache.prototype.destroyProgram=function(key){this._program3Ds[key].dispose(),this._program3Ds[key]=null,delete this._program3Ds[key],this._ids[key]=-1},AGALProgramCache.prototype.getKey=function(vertexCode,fragmentCode){return vertexCode+"---"+fragmentCode},AGALProgramCache._currentId=0,AGALProgramCache}();managers.AGALProgramCache=AGALProgramCache}(away.managers||(away.managers={}));away.managers}(away||(away={}));var AGALProgramCacheSingletonEnforcer=function(){function AGALProgramCacheSingletonEnforcer(){}return AGALProgramCacheSingletonEnforcer}(),away;!function(away){!function(managers){var RTTBufferManager=function(_super){function RTTBufferManager(se,stage){if(_super.call(this),this._viewWidth=-1,this._viewHeight=-1,this._textureWidth=-1,this._textureHeight=-1,this._buffersInvalid=!0,!se)throw new Error("No cheating the multiton!");this._renderToTextureRect=new away.geom.Rectangle,this._stage=stage}return __extends(RTTBufferManager,_super),RTTBufferManager.getInstance=function(stage){if(!stage)throw new Error("stage key cannot be null!");null==RTTBufferManager._instances&&(RTTBufferManager._instances=new Array);var rttBufferManager=RTTBufferManager.getRTTBufferManagerFromStage(stage);if(null==rttBufferManager){rttBufferManager=new RTTBufferManager(new SingletonEnforcer,stage);var vo=new RTTBufferManagerVO;vo.stage3d=stage,vo.rttbfm=rttBufferManager,RTTBufferManager._instances.push(vo)
}return rttBufferManager},RTTBufferManager.getRTTBufferManagerFromStage=function(stage){for(var r,l=RTTBufferManager._instances.length,c=0;l>c;c++)if(r=RTTBufferManager._instances[c],r.stage3d===stage)return r.rttbfm;return null},RTTBufferManager.deleteRTTBufferManager=function(stage){for(var r,l=RTTBufferManager._instances.length,c=0;l>c;c++)if(r=RTTBufferManager._instances[c],r.stage3d===stage)return RTTBufferManager._instances.splice(c,1),void 0},Object.defineProperty(RTTBufferManager.prototype,"textureRatioX",{get:function(){return this._buffersInvalid&&this.updateRTTBuffers(),this._textureRatioX},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"textureRatioY",{get:function(){return this._buffersInvalid&&this.updateRTTBuffers(),this._textureRatioY},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"viewWidth",{get:function(){return this._viewWidth},set:function(value){value!=this._viewWidth&&(this._viewWidth=value,this._buffersInvalid=!0,this._textureWidth=away.utils.TextureUtils.getBestPowerOf2(this._viewWidth),this._textureWidth>this._viewWidth?(this._renderToTextureRect.x=Math.floor(.5*(this._textureWidth-this._viewWidth)),this._renderToTextureRect.width=this._viewWidth):(this._renderToTextureRect.x=0,this._renderToTextureRect.width=this._textureWidth),this.dispatchEvent(new away.events.Event(away.events.Event.RESIZE)))},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"viewHeight",{get:function(){return this._viewHeight},set:function(value){value!=this._viewHeight&&(this._viewHeight=value,this._buffersInvalid=!0,this._textureHeight=away.utils.TextureUtils.getBestPowerOf2(this._viewHeight),this._textureHeight>this._viewHeight?(this._renderToTextureRect.y=Math.floor(.5*(this._textureHeight-this._viewHeight)),this._renderToTextureRect.height=this._viewHeight):(this._renderToTextureRect.y=0,this._renderToTextureRect.height=this._textureHeight),this.dispatchEvent(new away.events.Event(away.events.Event.RESIZE)))},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"renderToTextureVertexBuffer",{get:function(){return this._buffersInvalid&&this.updateRTTBuffers(),this._renderToTextureVertexBuffer},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"renderToScreenVertexBuffer",{get:function(){return this._buffersInvalid&&this.updateRTTBuffers(),this._renderToScreenVertexBuffer},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"indexBuffer",{get:function(){return this._indexBuffer},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"renderToTextureRect",{get:function(){return this._buffersInvalid&&this.updateRTTBuffers(),this._renderToTextureRect},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"textureWidth",{get:function(){return this._textureWidth},enumerable:!0,configurable:!0}),Object.defineProperty(RTTBufferManager.prototype,"textureHeight",{get:function(){return this._textureHeight},enumerable:!0,configurable:!0}),RTTBufferManager.prototype.dispose=function(){RTTBufferManager.deleteRTTBufferManager(this._stage),this._indexBuffer&&(this._indexBuffer.dispose(),this._renderToScreenVertexBuffer.dispose(),this._renderToTextureVertexBuffer.dispose(),this._renderToScreenVertexBuffer=null,this._renderToTextureVertexBuffer=null,this._indexBuffer=null)},RTTBufferManager.prototype.updateRTTBuffers=function(){var textureVerts,screenVerts,x,y,context=this._stage.context;null==this._renderToTextureVertexBuffer&&(this._renderToTextureVertexBuffer=context.createVertexBuffer(4,5)),null==this._renderToScreenVertexBuffer&&(this._renderToScreenVertexBuffer=context.createVertexBuffer(4,5)),this._indexBuffer||(this._indexBuffer=context.createIndexBuffer(6),this._indexBuffer.uploadFromArray([2,1,0,3,2,0],0,6)),this._textureRatioX=x=Math.min(this._viewWidth/this._textureWidth,1),this._textureRatioY=y=Math.min(this._viewHeight/this._textureHeight,1);var u1=.5*(1-x),u2=.5*(x+1),v1=.5*(y+1),v2=.5*(1-y);textureVerts=[-x,-y,u1,v1,0,x,-y,u2,v1,1,x,y,u2,v2,2,-x,y,u1,v2,3],screenVerts=[-1,-1,u1,v1,0,1,-1,u2,v1,1,1,1,u2,v2,2,-1,1,u1,v2,3],this._renderToTextureVertexBuffer.uploadFromArray(textureVerts,0,4),this._renderToScreenVertexBuffer.uploadFromArray(screenVerts,0,4),this._buffersInvalid=!1},RTTBufferManager}(away.events.EventDispatcher);managers.RTTBufferManager=RTTBufferManager;var RTTBufferManagerVO=function(){function RTTBufferManagerVO(){}return RTTBufferManagerVO}()}(away.managers||(away.managers={}));away.managers}(away||(away={}));var SingletonEnforcer=function(){function SingletonEnforcer(){}return SingletonEnforcer}();away.Debug.THROW_ERRORS=!1,away.Debug.LOG_PI_ERRORS=!1;var away;!function(away){var StageGLContext=function(_super){function StageGLContext(){_super.call(this)}return __extends(StageGLContext,_super),StageGLContext}(away.events.EventDispatcher);away.StageGLContext=StageGLContext}(away||(away={}));
